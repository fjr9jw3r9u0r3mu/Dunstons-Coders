<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dunstons-Coder v24 | Classic Ultra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <style>
        :root { --bg: #09090b; --sidebar: #121214; --border: #27272a; --accent: #22c55e; }
        body { background: var(--bg); color: #fafafa; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        .monaco-editor { padding-top: 8px; }
        .tab-active { background: #1e1e1e; color: var(--accent); border-top: 2px solid var(--accent); }
        .sidebar-item-active { background: #27272a; color: white; border-left: 3px solid var(--accent); }
        pre { white-space: pre-wrap; word-wrap: break-word; font-family: 'Fira Code', monospace; }
        .err-text { color: #ef4444; }
        .std-text { color: #d1d5db; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; }
    </style>
</head>
<body class="flex flex-col">

    <header class="h-12 bg-[#18181b] border-b border-[#27272a] flex items-center justify-between px-4">
        <div class="flex items-center gap-4">
            <h1 class="font-bold text-sm tracking-tight">DUNSTONS-<span class="text-green-500">CODER</span></h1>
            <div class="h-4 w-px bg-[#27272a]"></div>
            <select id="project-selector" onchange="switchProject(this.value)" class="bg-black text-[10px] text-gray-400 border border-[#27272a] px-2 py-1 rounded outline-none"></select>
            <div class="flex items-center gap-2 ml-4">
                <span class="text-[9px] text-gray-500 font-bold uppercase">Lvl <span id="lvl-val" class="text-green-500">1</span></span>
                <div class="w-20 h-1 bg-zinc-800 rounded-full overflow-hidden">
                    <div id="xp-bar" class="h-full bg-green-500 w-0 transition-all duration-500"></div>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="exportProject()" class="text-[10px] text-gray-400 hover:text-white uppercase font-bold"><i class="fa-solid fa-download"></i> Export</button>
            <button onclick="openAbout()" class="bg-green-600/10 text-green-500 border border-green-600/20 px-3 py-1 rounded text-[10px] font-bold">FOUNDER</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-64 bg-[#121214] border-r border-[#27272a] flex flex-col">
            <div class="p-3 space-y-2">
                <button onclick="newFile()" class="w-full bg-[#27272a] hover:bg-green-600 text-white py-2 rounded text-xs font-semibold transition-colors">+ New File</button>
                <input type="text" id="file-search" placeholder="Search files..." oninput="renderUI()" class="w-full bg-black border border-[#27272a] p-1.5 rounded text-[10px] outline-none focus:border-green-500">
            </div>
            <div id="file-tree" class="flex-1 overflow-y-auto px-2 space-y-0.5"></div>
            <div class="p-3 border-t border-[#27272a] bg-[#0c0c0e]">
                <label class="text-[9px] text-gray-500 uppercase font-bold mb-1 block">Language Engine</label>
                <select id="lang-select" onchange="updateLang()" class="w-full bg-black text-xs p-2 rounded border border-[#27272a] outline-none">
                    <option value="python">Python 3</option>
                    <option value="cpp">C++</option>
                    <option value="java">Java</option>
                    <option value="javascript">Node.js</option>
                    <option value="html">HTML5/CSS3</option>
                </select>
                <button id="run-btn" onclick="runCode()" class="w-full mt-2 bg-green-600 hover:bg-green-500 text-white py-2.5 rounded text-xs font-bold transition-all active:scale-95">RUN (Ctrl+Shift+R)</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-[#1e1e1e]">
            <div id="tabs-bar" class="flex bg-[#121214] h-9 border-b border-[#27272a] overflow-x-auto"></div>
            <div id="editor-container" class="flex-1"></div>
            <footer class="h-6 bg-[#18181b] border-t border-[#27272a] flex items-center justify-between px-3 text-[10px] text-gray-500">
                <div class="flex gap-4">
                    <span><i class="fa-solid fa-code-branch mr-1"></i> main</span>
                    <span id="char-count">0 Chars</span>
                </div>
                <span id="status-text">Ready</span>
            </footer>
        </main>

        <div id="resizer" class="w-1 bg-[#27272a] hover:bg-green-500 cursor-col-resize"></div>
        <div id="output-panel" class="w-96 bg-black flex flex-col">
            <div class="h-9 border-b border-[#27272a] flex items-center justify-between px-3 bg-[#121214]">
                <div class="flex h-full">
                    <button onclick="switchOutTab('term')" id="btn-term" class="px-3 text-[10px] font-bold uppercase border-b-2 border-green-500 text-green-500">Terminal</button>
                    <button onclick="switchOutTab('web')" id="btn-web" class="px-3 text-[10px] font-bold uppercase text-gray-500">Preview</button>
                </div>
                <button onclick="clearTerm()" class="text-[10px] text-gray-600 hover:text-white uppercase font-bold">Clear</button>
            </div>
            
            <div id="console" class="flex-1 p-4 font-mono text-xs overflow-y-auto bg-black"></div>
            <iframe id="preview" class="flex-1 hidden bg-white" sandbox="allow-scripts allow-same-origin"></iframe>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        let editor, activeId, saveTimeout, xp = parseInt(localStorage.getItem('dc_xp')) || 0;
        let activeProject = localStorage.getItem('dc_active_proj') || 'Default';
        let projects = JSON.parse(localStorage.getItem('dc_ultra_projects')) || { 
            'Default': [{id: '1', name: 'main.py', lang: 'python', content: 'print("Ultra v24 Loaded.")'}] 
        };

        const LANG_MAP = { py: 'python', cpp: 'cpp', java: 'java', js: 'javascript', html: 'html', css: 'css', txt: 'plaintext' };

        // --- INIT ---
        window.onload = () => {
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
            require(['vs/editor/editor.main'], () => {
                initEditor();
                initShortcuts();
                initResizer();
                updateXP(0);
                populateProjectSelector();
            });
        };

        function initEditor() {
            const f = projects[activeProject][0];
            activeId = f.id;
            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: f.content, language: f.lang, theme: 'vs-dark', automaticLayout: true, fontSize: 13, minimap: {enabled: false}
            });

            editor.onDidChangeModelContent(() => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(save, 500);
                document.getElementById('char-count').innerText = `${editor.getValue().length} Chars`;
            });

            editor.onDidBlurEditorText(() => save()); // Save on blur
            renderUI();
        }

        // --- CORE FUNCTIONS ---
        function save() {
            const f = projects[activeProject].find(x => x.id === activeId);
            if (f) {
                f.content = editor.getValue();
                localStorage.setItem('dc_ultra_projects', JSON.stringify(projects));
                document.getElementById('status-text').innerText = "Changes synced";
            }
        }

        async function runCode() {
            const f = projects[activeProject].find(x => x.id === activeId);
            const out = document.getElementById('console');
            const preview = document.getElementById('preview');
            
            if(f.lang === 'html') {
                switchOutTab('web');
                preview.srcdoc = f.content;
                return;
            }
            
            switchOutTab('term');
            out.innerHTML += `<div class="text-green-500 font-bold mt-2">>>> Executing ${f.name}...</div>`;
            
            try {
                const res = await fetch('https://emkc.org/api/v2/piston/execute', {
                    method: 'POST',
                    body: JSON.stringify({language: f.lang, version: "*", files: [{content: f.content}]})
                });
                const resData = await res.json();
                
                if (resData.run) {
                    if (resData.run.stdout) out.innerHTML += `<pre class="std-text">${resData.run.stdout}</pre>`;
                    if (resData.run.stderr) out.innerHTML += `<pre class="err-text">${resData.run.stderr}</pre>`;
                    if (!resData.run.stdout && !resData.run.stderr) out.innerHTML += `<div class="text-gray-600">[Process finished with no output]</div>`;
                    updateXP(20);
                } else {
                    out.innerHTML += `<div class="err-text">Engine Error: ${resData.message}</div>`;
                }
            } catch(e) { out.innerHTML += `<div class="err-text">Network Error: Could not connect to Piston API.</div>`; }
            out.scrollTop = out.scrollHeight;
        }

        // --- UI RENDERERS ---
        function renderUI() {
            const tree = document.getElementById('file-tree');
            const tabs = document.getElementById('tabs-bar');
            const search = document.getElementById('file-search').value.toLowerCase();
            
            tree.innerHTML = ''; tabs.innerHTML = '';
            projects[activeProject].forEach(f => {
                if (f.name.toLowerCase().includes(search)) {
                    const active = f.id === activeId;
                    tree.innerHTML += `
                        <div onclick="switchFile('${f.id}')" class="group p-2 text-[11px] cursor-pointer rounded flex justify-between items-center ${active ? 'sidebar-item-active' : 'text-gray-500 hover:bg-[#27272a]'}">
                            <span><i class="fa-solid ${f.lang === 'html' ? 'fa-code' : 'fa-file-lines'} mr-2 opacity-50"></i>${f.name}</span>
                            <i onclick="deleteFile(event, '${f.id}')" class="fa-solid fa-xmark opacity-0 group-hover:opacity-100 hover:text-red-500 px-1"></i>
                        </div>`;
                }
                
                if (f.id === activeId || projects[activeProject].length < 5) { // Simple tab management
                    const active = f.id === activeId;
                    tabs.innerHTML += `
                        <div onclick="switchFile('${f.id}')" class="px-4 flex items-center text-[10px] font-bold uppercase cursor-pointer transition-all ${active ? 'tab-active' : 'text-gray-500 border-r border-[#27272a] hover:bg-zinc-800'}">
                            ${f.name}
                        </div>`;
                }
            });
            const activeFile = projects[activeProject].find(x => x.id === activeId);
            if(activeFile) document.getElementById('lang-select').value = activeFile.lang;
        }

        // --- FILE MGMT ---
        function switchFile(id) {
            save();
            activeId = id;
            const f = projects[activeProject].find(x => x.id === id);
            editor.setValue(f.content);
            monaco.editor.setModelLanguage(editor.getModel(), f.lang);
            renderUI();
        }

        function newFile() {
            const name = prompt("Enter filename (with extension):", "script.py");
            if(!name) return;
            const ext = name.split('.').pop().toLowerCase();
            const id = Date.now().toString();
            projects[activeProject].push({
                id, name, lang: LANG_MAP[ext] || 'plaintext', content: ''
            });
            switchFile(id);
        }

        function deleteFile(e, id) {
            e.stopPropagation();
            if(projects[activeProject].length === 1) return alert("Cannot delete the only file.");
            if(!confirm("Delete this file?")) return;
            projects[activeProject] = projects[activeProject].filter(f => f.id !== id);
            if(activeId === id) switchFile(projects[activeProject][0].id);
            else renderUI();
            save();
        }

        // --- PROJECT MGMT ---
        function switchProject(name) {
            save();
            activeProject = name;
            localStorage.setItem('dc_active_proj', name);
            switchFile(projects[activeProject][0].id);
        }

        function populateProjectSelector() {
            const sel = document.getElementById('project-selector');
            sel.innerHTML = '';
            Object.keys(projects).forEach(p => {
                sel.innerHTML += `<option value="${p}" ${p === activeProject ? 'selected' : ''}>${p}</option>`;
            });
            sel.innerHTML += `<option value="__new">+ New Project</option>`;
        }

        // --- UTILS ---
        function switchOutTab(t) {
            document.getElementById('console').classList.toggle('hidden', t !== 'term');
            document.getElementById('preview').classList.toggle('hidden', t !== 'web');
            document.getElementById('btn-term').className = t === 'term' ? "px-3 text-[10px] font-bold uppercase border-b-2 border-green-500 text-green-500" : "px-3 text-[10px] font-bold uppercase text-gray-500";
            document.getElementById('btn-web').className = t === 'web' ? "px-3 text-[10px] font-bold uppercase border-b-2 border-green-500 text-green-500" : "px-3 text-[10px] font-bold uppercase text-gray-500";
        }

        function updateXP(v) {
            xp += v;
            localStorage.setItem('dc_xp', xp);
            document.getElementById('lvl-val').innerText = Math.floor(xp / 100) + 1;
            document.getElementById('xp-bar').style.width = (xp % 100) + '%';
        }

        function initShortcuts() {
            window.addEventListener('keydown', e => {
                if(e.ctrlKey && e.key === 's') { e.preventDefault(); save(); }
                if(e.ctrlKey && e.key === 'n') { e.preventDefault(); newFile(); }
                if(e.ctrlKey && e.shiftKey && e.key === 'R') { e.preventDefault(); runCode(); }
            });
        }

        function initResizer() {
            const resizer = document.getElementById('resizer'), panel = document.getElementById('output-panel');
            resizer.addEventListener('mousedown', e => {
                const doResize = md => {
                    const w = window.innerWidth - md.clientX;
                    if(w > 150 && w < 800) panel.style.width = w + 'px';
                };
                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', () => document.removeEventListener('mousemove', doResize));
            });
        }

        function clearTerm() { document.getElementById('console').innerHTML = ''; }
        function exportProject() {
            const blob = new Blob([JSON.stringify(projects[activeProject])], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${activeProject}_dunston.json`;
            a.click();
        }
        function openAbout() { alert("Dunston Jude Bandasa\nForm 3 Student & Founder\nClassic Ultra v24.0\nPerformance & Reliability Optimized."); }
    </script>
</body>
</html>
