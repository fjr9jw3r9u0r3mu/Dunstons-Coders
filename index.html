<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dunstons-Coder | Phoenix Edition</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* 2. NATIVE CSS - NO FRAMEWORKS TO BREAK */
        :root {
            --bg-dark: #0d1117;
            --bg-panel: #161b22;
            --border: #30363d;
            --accent: #238636;
            --text-main: #c9d1d9;
            --text-dim: #8b949e;
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            --font-code: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        header {
            height: 50px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            flex-shrink: 0;
        }

        .brand { font-weight: 800; color: #fff; font-size: 16px; letter-spacing: -0.5px; }
        .brand span { color: var(--accent); }

        .toolbar-btn {
            background: #21262d; border: 1px solid var(--border); color: var(--text-main);
            padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;
            transition: 0.2s; display: inline-flex; align-items: center; gap: 6px;
        }
        .toolbar-btn:hover { background: #30363d; border-color: #8b949e; }
        .btn-run { background: var(--accent); color: #fff; border: none; }
        .btn-run:hover { background: #2ea043; }
        .btn-danger { color: #ff7b72; border-color: #ff7b72; }
        .btn-danger:hover { background: rgba(255,123,114,0.1); }

        /* MAIN LAYOUT */
        .workspace { display: flex; flex: 1; overflow: hidden; }

        /* SIDEBAR */
        aside {
            width: 200px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .file-list { flex: 1; overflow-y: auto; padding: 10px; }
        .file-item {
            padding: 8px 10px; font-size: 13px; color: var(--text-dim);
            cursor: pointer; border-radius: 4px; margin-bottom: 2px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .file-item:hover { background: #21262d; color: #fff; }
        .file-item.active { background: #30363d; color: #fff; border-left: 3px solid var(--accent); }
        .file-icon { width: 16px; text-align: center; margin-right: 8px; }

        /* EDITOR AREA */
        .editor-stack { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        
        #editor-container { flex: 1; position: relative; }
        
        /* CONSOLE */
        #console-container {
            height: 200px;
            background: #000;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .console-header {
            padding: 5px 10px; background: #0d1117; border-bottom: 1px solid #21262d;
            font-size: 11px; font-weight: bold; color: var(--text-dim);
            display: flex; justify-content: space-between;
        }
        #console-output {
            flex: 1; padding: 10px; font-family: var(--font-code); font-size: 13px;
            overflow-y: auto; color: #e6edf3; white-space: pre-wrap;
        }
        .error-msg { color: #ff7b72; }
        .success-msg { color: #3fb950; }

        /* LOADING OVERLAY */
        #loader {
            position: fixed; inset: 0; background: #0d1117; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #21262d; border-top: 4px solid var(--accent);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <h3 style="color: #fff; margin-bottom: 10px;">Initializing Dunstons-Coder v15...</h3>
        <button onclick="hardReset()" class="toolbar-btn btn-danger">If stuck, click here to Factory Reset</button>
    </div>

    <header>
        <div class="brand"><i class="fa-solid fa-code"></i> DUNSTONS-<span>CODER</span></div>
        <div style="display:flex; gap: 10px;">
            <button class="toolbar-btn" onclick="saveProject()">
                <i class="fa-solid fa-floppy-disk"></i> Save
            </button>
            <button class="toolbar-btn" onclick="createNewFile()">
                <i class="fa-solid fa-plus"></i> New File
            </button>
            <button class="toolbar-btn btn-run" onclick="runCode()" id="runBtn">
                <i class="fa-solid fa-play"></i> RUN CODE
            </button>
        </div>
    </header>

    <div class="workspace">
        <aside>
            <div style="padding: 10px; font-size: 11px; font-weight: 700; color: #555; text-transform: uppercase;">Explorer</div>
            <div id="file-list" class="file-list"></div>
            
            <div style="padding: 10px; border-top: 1px solid var(--border);">
                <select id="lang-selector" onchange="changeLang()" style="width: 100%; background: #21262d; color: white; border: 1px solid #30363d; padding: 5px; border-radius: 4px;">
                    <option value="python">Python 3.10</option>
                    <option value="java">Java 17</option>
                    <option value="cpp">C++ (GCC)</option>
                    <option value="javascript">Node.js</option>
                </select>
            </div>
        </aside>

        <section class="editor-stack">
            <div id="editor-container"></div> <div id="console-container">
                <div class="console-header">
                    <span>TERMINAL / OUTPUT</span>
                    <span style="cursor: pointer;" onclick="clearConsole()">CLEAR</span>
                </div>
                <div id="console-output">System ready. Waiting for code...</div>
            </div>
        </section>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    
    <script>
        // --- GLOBAL STATE ---
        let editor = null;
        let files = [];
        let activeId = null;
        
        // --- DEFAULT DATA (Fallback) ---
        const DEFAULT_FILES = [
            { id: '1', name: 'main.py', content: 'print("Dunstons-Coder v15 is working!")\nfor i in range(5):\n    print(f"Count: {i}")', lang: 'python' }
        ];

        // --- 1. INITIALIZATION SAFETY CHECK ---
        function init() {
            try {
                // Try to load from storage, fallback to defaults if corrupt
                const saved = localStorage.getItem('dc_v15_phoenix');
                if (saved) {
                    files = JSON.parse(saved);
                } else {
                    files = JSON.parse(JSON.stringify(DEFAULT_FILES));
                }
                
                if (!files || files.length === 0) throw new Error("Empty file list");
                
                activeId = files[0].id;
                loadMonaco(); // Start loading editor
                
            } catch (e) {
                console.error("Storage corrupted, resetting...", e);
                hardReset();
            }
        }

        // --- 2. MONACO EDITOR LOADER ---
        function loadMonaco() {
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
            
            require(['vs/editor/editor.main'], function() {
                try {
                    editor = monaco.editor.create(document.getElementById('editor-container'), {
                        value: files[0].content,
                        language: files[0].lang === 'js' ? 'javascript' : files[0].lang,
                        theme: 'vs-dark',
                        automaticLayout: true,
                        minimap: { enabled: false },
                        fontSize: 14,
                        scrollBeyondLastLine: false,
                        padding: { top: 10 }
                    });

                    // Auto-save on type
                    editor.onDidChangeModelContent(() => {
                        const f = files.find(file => file.id === activeId);
                        if(f) {
                            f.content = editor.getValue();
                            localStorage.setItem('dc_v15_phoenix', JSON.stringify(files));
                        }
                    });

                    renderFileList();
                    updateLangSelect(files[0].lang);
                    
                    // Hide loader when done
                    document.getElementById('loader').style.display = 'none';
                    
                } catch (e) {
                    alert("Editor failed to load. Check internet connection.");
                }
            });
        }

        // --- 3. UI FUNCTIONS ---
        function renderFileList() {
            const list = document.getElementById('file-list');
            list.innerHTML = '';
            
            files.forEach(f => {
                const div = document.createElement('div');
                div.className = `file-item ${f.id === activeId ? 'active' : ''}`;
                
                let iconClass = 'fa-file-code';
                if(f.name.endsWith('.py')) iconClass = 'fa-python';
                if(f.name.endsWith('.java')) iconClass = 'fa-java';
                
                div.innerHTML = `<i class="fa-brands ${iconClass} file-icon"></i> ${f.name}`;
                div.onclick = () => switchFile(f.id);
                list.appendChild(div);
            });
        }

        function switchFile(id) {
            if(!editor) return;
            activeId = id;
            const f = files.find(file => file.id === id);
            
            // Map simple lang to Monaco lang
            let monacoLang = f.lang;
            if (f.lang === 'js') monacoLang = 'javascript';
            if (f.lang === 'cpp') monacoLang = 'cpp';
            
            monaco.editor.setModelLanguage(editor.getModel(), monacoLang);
            editor.setValue(f.content);
            updateLangSelect(f.lang);
            renderFileList();
        }

        function updateLangSelect(lang) {
            document.getElementById('lang-selector').value = lang;
        }

        function changeLang() {
            const newLang = document.getElementById('lang-selector').value;
            const f = files.find(file => file.id === activeId);
            f.lang = newLang;
            switchFile(activeId); // refresh editor highlighting
        }

        function createNewFile() {
            const name = prompt("Filename (e.g. test.py):");
            if(name) {
                let lang = 'python';
                if(name.endsWith('.java')) lang = 'java';
                if(name.endsWith('.cpp')) lang = 'cpp';
                if(name.endsWith('.js')) lang = 'javascript';
                
                const newFile = {
                    id: Date.now().toString(),
                    name: name,
                    content: '',
                    lang: lang
                };
                files.push(newFile);
                switchFile(newFile.id);
            }
        }

        function saveProject() {
            localStorage.setItem('dc_v15_phoenix', JSON.stringify(files));
            logConsole("Project saved to browser storage.", "success-msg");
        }

        function hardReset() {
            if(confirm("This will delete all saved code and reset the IDE. Are you sure?")) {
                localStorage.removeItem('dc_v15_phoenix');
                location.reload();
            }
        }

        function clearConsole() {
            document.getElementById('console-output').innerHTML = '';
        }

        function logConsole(text, type = "") {
            const consoleDiv = document.getElementById('console-output');
            const entry = document.createElement('div');
            entry.textContent = text;
            if(type) entry.className = type;
            consoleDiv.appendChild(entry);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        // --- 4. EXECUTION ENGINE (PISTON API) ---
        async function runCode() {
            if(!editor) return;
            
            const btn = document.getElementById('runBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> RUNNING...';
            
            clearConsole();
            
            // Prepare payload
            const activeFile = files.find(f => f.id === activeId);
            
            // Piston Version Map
            const versions = {
                'python': '3.10.0',
                'java': '15.0.2',
                'javascript': '18.15.0',
                'cpp': '10.2.0'
            };

            // Ensure Main class for Java
            let apiFiles = files.map(f => ({ name: f.name, content: f.content }));
            
            // Move active file to front (main entry point usually)
            apiFiles = [
                { name: activeFile.name, content: activeFile.content },
                ...files.filter(f => f.id !== activeId).map(f => ({ name: f.name, content: f.content }))
            ];

            try {
                const response = await fetch('https://emkc.org/api/v2/piston/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        language: activeFile.lang,
                        version: versions[activeFile.lang] || '*',
                        files: apiFiles
                    })
                });

                const data = await response.json();

                if (data.run) {
                    if (data.run.stdout) logConsole(data.run.stdout);
                    if (data.run.stderr) logConsole(data.run.stderr, 'error-msg');
                    if (!data.run.stdout && !data.run.stderr) logConsole("Program finished with no output.");
                } else {
                    logConsole("Error: " + (data.message || "Unknown API Error"), 'error-msg');
                }

            } catch (error) {
                logConsole("Network Error: Could not connect to compiler.", 'error-msg');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-play"></i> RUN CODE';
            }
        }

        // --- START APP ---
        window.addEventListener('load', init);

    </script>
</body>
</html>
