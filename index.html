<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dunstons-Coder | Omega v25 Ultra</title>

<!-- UI libs -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Monaco loader -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&family=Fira+Code:wght@400;500&display=swap');

:root {
  --bg:#050505; --panel:#0d0d0f; --accent:#10b981; --border:#1f1f23; --text:#f4f4f5;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:'Plus Jakarta Sans',sans-serif;
  background:var(--bg); color:var(--text); height:100vh; overflow:hidden;
}
.monaco-editor{padding-top:10px;background:transparent!important}
.tab-active{color:var(--accent);border-bottom:2px solid var(--accent);background:rgba(16,185,129,0.05)}
pre{white-space:pre-wrap;word-wrap:break-word;font-family:'Fira Code',monospace}
.err-text{color:#ef4444;font-weight:700}
.sidebar-item-active{background:rgba(16,185,129,0.06);color:var(--accent)}
/* simple scrollbar */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-thumb{background:#2b2b2b;border-radius:10px}
.file-action{opacity:0; transition:opacity .15s}
.file-row:hover .file-action{opacity:1}
.tab-close{opacity:.6}
.tab-close:hover{opacity:1}
</style>
</head>
<body class="flex flex-col">

<!-- Header -->
<header class="h-16 border-b border-[#1f1f23] flex items-center justify-between px-6 bg-black/50 z-50">
  <div class="flex items-center gap-6">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-gradient-to-br from-emerald-400 to-green-700 rounded-xl flex items-center justify-center shadow-lg">
        <i class="fa-solid fa-atom text-black text-xl"></i>
      </div>
      <div>
        <h1 class="font-extrabold text-sm tracking-widest uppercase italic leading-none">Dunstons-<span class="text-emerald-500">Coder</span></h1>
        <div class="text-[9px] text-gray-400">OMEGA V25 ULTRA</div>
      </div>
    </div>
    <div class="h-8 w-px bg-[#27272a]"></div>
    <button onclick="createNewFile()" title="New file (Ctrl+N)" class="px-3 py-1 bg-[#161616] rounded text-sm">+ New File</button>
    <input id="import-input" type="file" accept=".json" class="hidden" />
  </div>

  <div class="flex items-center gap-4">
    <div class="flex flex-col items-end">
      <div class="text-[9px] font-bold text-gray-400 uppercase">Level <span id="user-level" class="text-emerald-500">1</span></div>
      <div class="w-36 h-1 bg-[#1f1f23] rounded overflow-hidden mt-1">
        <div id="xp-bar" class="h-full bg-emerald-500 w-0 transition-all"></div>
      </div>
    </div>
    <button onclick="exportProject()" title="Export project JSON" class="w-10 h-10 rounded bg-[#121214] border border-[#1f1f23] flex items-center justify-center"><i class="fa-solid fa-download"></i></button>
    <button onclick="openModal('founder')" title="Founder" class="px-3 py-1 bg-[#121214] rounded text-sm">Founder</button>
  </div>
</header>

<!-- Layout -->
<div class="flex flex-1 h-[calc(100vh-64px)]">
  <!-- Sidebar -->
  <aside class="w-64 bg-[#09090b] border-r border-[#1f1f23] p-4 flex flex-col">
    <div class="mb-2 text-xs uppercase text-gray-400 font-bold">Project Explorer</div>
    <div id="file-tree" class="flex-1 overflow-y-auto space-y-1"></div>

    <div class="mt-4 bg-[#0d0d0f] p-3 rounded-xl border border-[#1f1f23]">
      <label class="text-xs text-gray-400 uppercase">Runtime</label>
      <select id="lang-select" onchange="updateLangManual()" class="w-full mt-2 bg-black text-sm p-2 rounded border border-[#262626]">
        <option value="python">Python 3</option>
        <option value="cpp">C++</option>
        <option value="java">Java</option>
        <option value="javascript">Node.js</option>
        <option value="html">Web Live</option>
      </select>
      <button id="run-btn" onclick="runCode()" class="mt-3 w-full bg-emerald-500 text-black py-2 rounded font-bold">Run (Ctrl+Enter)</button>
      <div class="flex gap-2 mt-3">
        <button onclick="save()" class="flex-1 bg-[#161616] py-1 rounded text-sm">Save (Ctrl+S)</button>
        <button onclick="clearConsole()" class="bg-[#161616] px-3 rounded">Clear</button>
      </div>
      <div class="mt-3 text-xs text-gray-500">Tip: HTML files show in Live View.</div>
    </div>
  </aside>

  <!-- Editor area -->
  <main class="flex-1 flex flex-col">
    <div id="tabs-bar" class="flex items-center h-12 bg-[#0b0b0c] border-b border-[#1f1f23] px-3 gap-1 overflow-x-auto"></div>
    <div id="editor-container" class="flex-1"></div>
    <div class="h-8 bg-[#0d0d0f] border-t border-[#1f1f23] flex items-center justify-between px-4 text-sm text-gray-400">
      <div><span id="char-count">0 chars</span></div>
      <div>OMEGA ENGINE v25</div>
    </div>
  </main>

  <!-- Output panel -->
  <div id="resizer" class="w-1 bg-[#1f1f23] cursor-col-resize"></div>
  <div id="output-panel" class="w-1/3 bg-black border-l border-[#1f1f23] flex flex-col">
    <div class="h-12 border-b border-[#1f1f23] flex items-center justify-between px-4">
      <div class="flex items-center gap-4">
        <button id="tab-term" onclick="switchOut('term')" class="text-xs font-bold text-emerald-500 border-b-2 border-emerald-500 h-full px-2">Console</button>
        <button id="tab-web" onclick="switchOut('web')" class="text-xs font-bold text-gray-400 h-full px-2">Preview</button>
      </div>
      <div class="text-xs text-gray-400">Output</div>
    </div>

    <div id="console-view" class="flex-1 p-4 overflow-y-auto font-mono text-sm text-gray-300 bg-black">
      <div id="terminal-output">>> System initialized. Run code to see output.</div>
    </div>

    <div id="preview-view" class="flex-1 hidden bg-white">
      <iframe id="web-frame" class="w-full h-full" sandbox="allow-scripts allow-same-origin"></iframe>
    </div>
  </div>
</div>

<!-- Founder modal -->
<div id="modal-overlay" class="fixed inset-0 hidden items-center justify-center bg-black/80 z-50">
  <div id="modal-founder" class="bg-[#0d0d0f] rounded-xl p-8 max-w-lg w-full border border-[#1f1f23]">
    <div class="text-center">
      <div class="w-20 h-20 mx-auto bg-emerald-500 rounded-lg mb-4"></div>
      <h2 class="text-2xl font-bold">Dunston Jude Bandasa</h2>
      <p class="text-sm text-gray-400 mt-2">Founder • Visionary • Student</p>
      <p class="text-xs text-gray-400 mt-4">"Build, learn, and ship."</p>
      <div class="mt-6 flex justify-center">
        <button onclick="closeModals()" class="px-4 py-2 bg-white text-black rounded">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Hidden import input -->
<input id="file-import" type="file" accept=".json" style="display:none" />

<!-- Script -->
<script>
/* ---------- Core state ---------- */
let editor, activeId, saveTimeout;
let xp = parseInt(localStorage.getItem('dc_xp')) || 0;
let PROJECT_KEY = 'dc_v25_project';
let data = JSON.parse(localStorage.getItem(PROJECT_KEY)) || {
  files: [
    { id: 'f-' + Date.now(), name: 'main.py', lang: 'python', content: 'print("Omega v25 Ultra - Hello")' }
  ]
};

const LANG_EXTS = { py: 'python', cpp: 'cpp', java: 'java', js: 'javascript', html: 'html' };

/* ---------- Init Monaco + UI ---------- */
window.addEventListener('load', () => {
  require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
  require(['vs/editor/editor.main'], () => {
    initEditor();
    renderUI();
    initResizer();
    initShortcuts();
    updateXP(0);
  });
});

/* ---------- Editor ---------- */
function initEditor() {
  const f = data.files[0];
  activeId = f.id;
  editor = monaco.editor.create(document.getElementById('editor-container'), {
    value: f.content,
    language: mapToMonacoLang(f.lang),
    theme: 'vs-dark',
    automaticLayout: true,
    fontSize: 14,
    minimap: { enabled: false },
    fontFamily: 'Fira Code',
    padding: { top: 12 }
  });

  editor.onDidChangeModelContent(() => {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(save, 500);
    updateCharCount();
  });
}

/* ---------- UI rendering ---------- */
function renderUI() {
  // file tree
  const tree = document.getElementById('file-tree');
  tree.innerHTML = '';
  data.files.forEach(f => {
    const active = f.id === activeId;
    const div = document.createElement('div');
    div.className = 'p-2 rounded file-row flex items-center justify-between ' + (active? 'sidebar-item-active' : 'text-gray-400');
    div.onclick = () => switchFile(f.id);
    div.innerHTML = `<div class="flex items-center gap-3"><i class="fa-solid fa-file-code opacity-60"></i><div class="text-sm">${escapeHtml(f.name)}</div></div>
                     <div class="file-action flex gap-1">
                       <button title="Rename" class="text-xs p-1" onclick="event.stopPropagation(); renameFile('${f.id}')"><i class="fa-solid fa-pen-to-square"></i></button>
                       <button title="Delete" class="text-xs p-1 text-red-500" onclick="event.stopPropagation(); deleteFile('${f.id}')"><i class="fa-solid fa-trash"></i></button>
                     </div>`;
    tree.appendChild(div);
  });

  // tabs
  const tabs = document.getElementById('tabs-bar');
  tabs.innerHTML = '';
  data.files.forEach(f => {
    const active = f.id === activeId;
    const tab = document.createElement('div');
    tab.className = 'flex items-center gap-2 px-3 py-2 cursor-pointer ' + (active ? 'tab-active' : 'text-gray-400');
    tab.onclick = () => switchFile(f.id);
    tab.innerHTML = `<div class="font-bold text-xs">${escapeHtml(f.name)}</div>
                     <div class="ml-2 tab-close text-xs" title="Close" onclick="event.stopPropagation(); closeTab('${f.id}')">&nbsp;✕</div>`;
    tabs.appendChild(tab);
  });

  updateLangSelectForActive();
  updateCharCount();
}

/* ---------- File operations ---------- */
function createNewFile() {
  const name = prompt('New filename (e.g. script.py, index.html):', 'script.py');
  if (!name) return;
  const id = 'f-' + Date.now();
  const ext = name.split('.').pop().toLowerCase();
  const lang = LANG_EXTS[ext] || 'plaintext';
  const file = { id, name, lang, content: defaultContentFor(lang, name) };
  data.files.push(file);
  switchFile(id);
  renderUI();
  save();
}

function defaultContentFor(lang, name) {
  if (lang === 'python') return 'print("Hello from Python")';
  if (lang === 'javascript') return 'console.log("Hello from Node.js");';
  if (lang === 'html') return '<!doctype html>\\n<html><body><h1>Hello</h1></body></html>';
  if (lang === 'cpp') return '#include <iostream>\\nint main(){ std::cout<<\"Hello C++\\n\"; return 0; }';
  if (lang === 'java') return 'public class Main { public static void main(String[] a){ System.out.println(\"Hello Java\"); } }';
  return '';
}

function renameFile(id) {
  const f = data.files.find(x => x.id === id);
  if (!f) return;
  const newName = prompt('Rename file:', f.name);
  if (!newName) return;
  f.name = newName;
  const ext = newName.split('.').pop().toLowerCase();
  f.lang = LANG_EXTS[ext] || f.lang;
  if (f.id === activeId) {
    monaco.editor.setModelLanguage(editor.getModel(), mapToMonacoLang(f.lang));
  }
  renderUI();
  save();
}

function deleteFile(id) {
  if (data.files.length === 1) { alert('Project must have at least one file.'); return; }
  if (!confirm('Delete file permanently?')) return;
  const idx = data.files.findIndex(x => x.id === id);
  if (idx === -1) return;
  data.files.splice(idx, 1);
  if (activeId === id) activeId = data.files[0].id;
  switchFile(activeId);
  renderUI();
  save();
}

function closeTab(id) {
  // simply remove tab from view by switching to first file (tabs are same as files)
  if (activeId === id && data.files.length > 0) {
    const other = data.files.find(x => x.id !== id);
    if (other) switchFile(other.id);
  }
}

/* ---------- Switch file ---------- */
function switchFile(id) {
  // save current
  const cur = data.files.find(x => x.id === activeId);
  if (cur) cur.content = editor.getValue();
  // switch
  activeId = id;
  const f = data.files.find(x => x.id === id);
  if (!f) return;
  // update editor
  if (editor) {
    editor.setValue(f.content || '');
    monaco.editor.setModelLanguage(editor.getModel(), mapToMonacoLang(f.lang));
  }
  renderUI();
}

/* ---------- Save / load / export / import ---------- */
function save() {
  const f = data.files.find(x => x.id === activeId);
  if (f) f.content = editor.getValue();
  localStorage.setItem(PROJECT_KEY, JSON.stringify(data));
  showStatus('Saved locally');
}

function exportProject() {
  save();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'dunston_project.json';
  a.click();
}

document.getElementById('import-input').addEventListener('change', (ev) => {
  const file = ev.target.files[0];
  if (!file) return;
  const fr = new FileReader();
  fr.onload = () => {
    try {
      const parsed = JSON.parse(fr.result);
      if (parsed && parsed.files) {
        data = parsed;
        save();
        renderUI();
        switchFile(data.files[0].id);
        showStatus('Project imported');
      } else alert('Invalid project file');
    } catch (e) {
      alert('Import error: ' + e.message);
    }
  };
  fr.readAsText(file);
  ev.target.value = '';
});

/* ---------- Run / Console / Preview ---------- */
async function runCode() {
  save();
  const f = data.files.find(x => x.id === activeId);
  const term = document.getElementById('terminal-output');
  if (!f) return;

  // HTML preview
  if (f.lang === 'html') {
    switchOut('web');
    document.getElementById('web-frame').srcdoc = f.content;
    showStatus('Rendered HTML preview');
    updateXP(10);
    return;
  }

  switchOut('term');
  appendConsole(`>>> Executing ${f.name} ...`, 'info');

  // prepare Piston payload - include all files to allow multi-file runs, special C++ build wrapper
  let filesPayload = data.files.map(fl => ({ name: fl.name, content: fl.content }));
  let lang = f.lang;

  // C++: build wrapper (use source filename m.cpp)
  if (lang === 'cpp') {
    filesPayload = [
      { name: 'source.cpp', content: f.content },
      { name: 'run.sh', content: 'g++ -std=c++20 -pthread source.cpp -O2 -o a.out && ./a.out' }
    ];
    lang = 'bash';
  }

  // Java: ensure Main.java exists and public class Main; if not, try run with provided files but set name
  if (lang === 'java') {
    // ensure file naming to Main.java if possible
    const hasMain = filesPayload.some(fl => fl.name === 'Main.java');
    if (!hasMain) {
      // warn but still try: create Main.java wrapper if code looks like a class with main absent
      // we'll just attempt to run with given files; Piston requires proper naming otherwise user should supply Main.java
      appendConsole('Note: Java execution expects a Main.java with public class Main.', 'warn');
    }
  }

  // Build request
  const payload = {
    language: lang,
    version: "*",
    files: filesPayload
  };

  try {
    const res = await fetch('https://emkc.org/api/v2/piston/execute', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('Execution engine error: ' + res.status);
    const json = await res.json();

    // show stdout / stderr
    if (json.run) {
      if (json.run.stdout) appendConsole(json.run.stdout, 'stdout');
      if (json.run.stderr) appendConsole(json.run.stderr, 'stderr');
      if (!json.run.stdout && !json.run.stderr) appendConsole('(Process finished with no output)', 'info');
      updateXP(25);
    } else {
      appendConsole('No run data returned.', 'warn');
    }
  } catch (e) {
    appendConsole('Execution error: ' + e.message, 'stderr');
  }
}

/* append console with simple formatting */
function appendConsole(text, type = 'stdout') {
  const out = document.getElementById('terminal-output');
  const wrapper = document.createElement('pre');
  wrapper.style.margin = '0 0 8px 0';
  if (type === 'stderr') wrapper.className = 'err-text';
  else if (type === 'info') wrapper.style.color = '#8b949e';
  else if (type === 'warn') wrapper.style.color = '#f59e0b';
  wrapper.textContent = text;
  out.appendChild(wrapper);
  out.parentElement.scrollTop = out.parentElement.scrollHeight;
}

function clearConsole() {
  document.getElementById('terminal-output').innerHTML = '';
}

/* ---------- UI helpers ---------- */
function switchOut(mode) {
  document.getElementById('console-view').classList.toggle('hidden', mode !== 'term');
  document.getElementById('preview-view').classList.toggle('hidden', mode !== 'web');
  document.getElementById('tab-term').className = mode === 'term' ? 'text-xs font-bold text-emerald-500 border-b-2 border-emerald-500 h-full px-2' : 'text-xs font-bold text-gray-400 h-full px-2';
  document.getElementById('tab-web').className = mode === 'web' ? 'text-xs font-bold text-emerald-500 border-b-2 border-emerald-500 h-full px-2' : 'text-xs font-bold text-gray-400 h-full px-2';
}

function updateLangManual() {
  const f = data.files.find(x => x.id === activeId);
  if (!f) return;
  f.lang = document.getElementById('lang-select').value;
  monaco.editor.setModelLanguage(editor.getModel(), mapToMonacoLang(f.lang));
  save();
}

function updateLangSelectForActive() {
  const f = data.files.find(x => x.id === activeId);
  if (!f) return;
  const sel = document.getElementById('lang-select');
  if (sel) sel.value = f.lang || 'plaintext';
}

function showStatus(msg) {
  appendConsole(msg, 'info');
}

/* ---------- XP / char count ---------- */
function updateXP(delta) {
  if (delta) xp += delta;
  localStorage.setItem('dc_xp', xp);
  const level = Math.floor(xp / 100) + 1;
  document.getElementById('user-level').innerText = level;
  document.getElementById('xp-bar').style.width = (xp % 100) + '%';
}

function updateCharCount() {
  const val = editor ? editor.getValue().length : 0;
  document.getElementById('char-count').innerText = val + ' chars';
}

/* ---------- Resizer ---------- */
function initResizer() {
  const resizer = document.getElementById('resizer');
  const output = document.getElementById('output-panel');
  let dragging = false;
  resizer.addEventListener('mousedown', (e) => {
    dragging = true;
    document.body.style.cursor = 'col-resize';
    const move = (ev) => {
      if (!dragging) return;
      const newWidth = Math.max(240, window.innerWidth - ev.clientX);
      if (newWidth < window.innerWidth * 0.75) output.style.width = newWidth + 'px';
    };
    const up = () => {
      dragging = false;
      document.body.style.cursor = '';
      document.removeEventListener('mousemove', move);
      document.removeEventListener('mouseup', up);
    };
    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', up);
  });
}

/* ---------- Shortcuts ---------- */
function initShortcuts() {
  window.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
      e.preventDefault(); save(); showStatus('Saved');
    }
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault(); runCode();
    }
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'n') {
      e.preventDefault(); createNewFile();
    }
  });
}

/* ---------- Misc helpers ---------- */
function mapToMonacoLang(lang) {
  if (!lang) return 'plaintext';
  if (lang === 'cpp') return 'cpp';
  if (lang === 'javascript' || lang === 'js') return 'javascript';
  if (lang === 'python') return 'python';
  if (lang === 'java') return 'java';
  if (lang === 'html') return 'html';
  return lang;
}

function escapeHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ---------- Modal ---------- */
function openModal(id) {
  document.getElementById('modal-overlay').style.display = 'flex';
  const el = document.getElementById('modal-' + id);
  if (el) el.style.display = 'block';
}
function closeModals() {
  document.getElementById('modal-overlay').style.display = 'none';
  document.querySelectorAll('[id^="modal-"]').forEach(m => m.style.display = 'none');
}

/* ---------- Utilities: load initial file into editor on first run ---------- */
(function boot() {
  // ensure activeId exists
  if (!data.files || data.files.length === 0) {
    data = { files: [{ id: 'f-' + Date.now(), name: 'main.py', lang: 'python', content: 'print(\"Hello\")' }] };
    save();
  } else {
    // ensure each file has id, name, lang, content
    data.files = data.files.map(f => ({
      id: f.id || ('f-' + Date.now()),
      name: f.name || 'file.txt',
      lang: f.lang || LANG_EXTS[f.name?.split('.').pop()?.toLowerCase()] || 'plaintext',
      content: f.content || ''
    }));
    localStorage.setItem(PROJECT_KEY, JSON.stringify(data));
  }
})();
</script>
</body>
</html>
