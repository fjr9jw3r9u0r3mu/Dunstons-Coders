<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dunstons-Coder v14.0 Hyperion</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --sidebar-w: 240px; --terminal-h: 30%; }
        body { background: #0d0d0d; color: #e0e0e0; overflow: hidden; font-family: 'Inter', system-ui; }
        #app { display: grid; grid-template-columns: var(--sidebar-w) 1fr; height: 100vh; }
        .editor-container { display: grid; grid-template-rows: 1fr var(--terminal-h); overflow: hidden; }
        #terminal { background: #050505; border-top: 1px solid #333; font-family: 'Fira Code', monospace; padding: 10px; overflow-y: auto; white-space: pre-wrap; font-size: 13px; }
        .tab { padding: 8px 16px; cursor: pointer; border-right: 1px solid #222; background: #1a1a1a; display: flex; align-items: center; gap: 8px; font-size: 12px; transition: 0.2s; }
        .tab.active { background: #2d2d2d; border-bottom: 2px solid #3b82f6; color: #fff; }
        .tab:hover { background: #252525; }
        .ansi-red { color: #ff5555; } .ansi-green { color: #50fa7b; } .ansi-yellow { color: #f1fa8c; }
        .ansi-blue { color: #8be9fd; } .ansi-white { color: #f8f8f2; }
        #resizer { cursor: row-resize; height: 4px; background: #333; }
        #resizer:hover { background: #3b82f6; }
        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="app">
    <aside class="border-right border-[#333] bg-[#111] p-4 flex flex-col gap-4">
        <h1 class="text-blue-500 font-bold text-lg tracking-tighter italic">HYPERION v14.0</h1>
        <div class="flex flex-col gap-2">
            <button onclick="createNewFile()" class="w-full bg-[#222] hover:bg-[#333] py-2 rounded text-xs">+ New File</button>
            <div id="file-list" class="flex flex-col gap-1 overflow-y-auto max-h-[40vh]"></div>
        </div>
        <hr class="border-[#222]">
        <div class="flex flex-col gap-3">
            <label class="text-[10px] text-gray-500 uppercase font-bold">Language</label>
            <select id="lang-select" onchange="updateLang()" class="bg-[#222] text-xs p-2 rounded outline-none border border-[#444]"></select>
            <label class="text-[10px] text-gray-500 uppercase font-bold">Project Controls</label>
            <button onclick="exportProject()" class="text-xs text-left px-2 py-1 hover:bg-[#222] rounded">ðŸ’¾ Export .json</button>
            <button onclick="takeSnapshot()" class="text-xs text-left px-2 py-1 hover:bg-[#222] rounded">ðŸ“¸ Save Snapshot</button>
            <button onclick="testAllLanguages()" class="text-xs text-left px-2 py-1 hover:bg-[#222] rounded text-yellow-500">ðŸ§ª Health Check</button>
        </div>
    </aside>

    <main class="editor-container">
        <div class="flex flex-col overflow-hidden">
            <div class="bg-[#1a1a1a] flex justify-between items-center border-b border-[#333]">
                <div id="tabs-container" class="flex overflow-x-auto"></div>
                <div class="px-4 flex gap-4 items-center">
                    <input type="text" id="stdin-input" placeholder="Program stdin..." class="bg-[#000] text-xs p-1 rounded border border-[#333] w-32 outline-none focus:border-blue-500">
                    <button onclick="runCode()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1 rounded text-sm font-bold transition flex items-center gap-2">
                        â–¶ RUN <span class="text-[10px] opacity-50 font-normal">Ctrl+Enter</span>
                    </button>
                </div>
            </div>
            <div id="editor" class="h-full"></div>
        </div>
        
        <div class="flex flex-col">
            <div id="resizer"></div>
            <div class="bg-[#0a0a0a] px-4 py-1 flex justify-between items-center border-t border-[#333]">
                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">Console Output</span>
                <button onclick="clearConsole()" class="text-[10px] text-gray-400 hover:text-white">Clear</button>
            </div>
            <div id="terminal"></div>
        </div>
    </main>
</div>

<script>
    let editor, activeFileId;
    let files = JSON.parse(localStorage.getItem('hyperion_project')) || [
        { id: '1', name: 'main.py', content: 'print("Hello from Hyperion v14!")', lang: 'python' }
    ];
    
    const RUNTIMES = {
        "python": { v: "3.10.0", name: "Python", template: "def main():\n    print('Hello World')\n\nif __name__ == '__main__':\n    main()" },
        "javascript": { v: "18.15.0", name: "Node.js", template: "console.log('Node JS execution');" },
        "java": { v: "17.0.2", name: "Java", template: "public class Main {\n    public static void main(String[] args) {\n        System.out.println(\"Java 17 Execution\");\n    }\n}" },
        "cpp": { v: "10.2.0", name: "C++", template: "#include <iostream>\nint main() {\n    std::cout << \"C++ 10.2 Ready\" << std::endl;\n    return 0;\n}" }
    };

    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
    require(['vs/editor/editor.main'], function () {
        editor = monaco.editor.create(document.getElementById('editor'), {
            theme: 'vs-dark',
            fontSize: 14,
            automaticLayout: true,
            minimap: { enabled: false },
            padding: { top: 10 }
        });

        editor.onDidChangeModelContent(() => {
            const file = files.find(f => f.id === activeFileId);
            if (file) file.content = editor.getValue();
            saveProject();
        });

        initUI();
    });

    function initUI() {
        const select = document.getElementById('lang-select');
        Object.keys(RUNTIMES).forEach(key => {
            const opt = document.createElement('option');
            opt.value = key; opt.textContent = `${RUNTIMES[key].name} (${RUNTIMES[key].v})`;
            select.appendChild(opt);
        });
        renderFileList();
        switchFile(files[0].id);
    }

    function renderFileList() {
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        files.forEach(f => {
            const div = document.createElement('div');
            div.className = `p-2 text-xs cursor-pointer rounded flex justify-between group ${activeFileId === f.id ? 'bg-[#2d2d2d]' : 'hover:bg-[#1a1a1a]'}`;
            div.innerHTML = `<span>ðŸ“„ ${f.name}</span> <span onclick="deleteFile('${f.id}')" class="hidden group-hover:block text-red-500">Ã—</span>`;
            div.onclick = (e) => { if(e.target.tagName !== 'SPAN' || !e.target.classList.contains('text-red-500')) switchFile(f.id); };
            list.appendChild(div);
        });
        renderTabs();
    }

    function renderTabs() {
        const container = document.getElementById('tabs-container');
        container.innerHTML = '';
        files.forEach(f => {
            const tab = document.createElement('div');
            tab.className = `tab ${activeFileId === f.id ? 'active' : ''}`;
            tab.innerHTML = `<span>${f.name}</span>`;
            tab.onclick = () => switchFile(f.id);
            container.appendChild(tab);
        });
    }

    function switchFile(id) {
        activeFileId = id;
        const file = files.find(f => f.id === id);
        editor.setValue(file.content);
        monaco.editor.setModelLanguage(editor.getModel(), file.lang === 'cpp' ? 'cpp' : file.lang);
        document.getElementById('lang-select').value = file.lang;
        renderFileList();
    }

    function createNewFile() {
        const name = prompt("File name (include extension):", "script.py");
        if (!name) return;
        const lang = name.split('.').pop();
        const newFile = { id: Date.now().toString(), name, content: '', lang: lang === 'js' ? 'javascript' : lang };
        files.push(newFile);
        switchFile(newFile.id);
    }

    function saveProject() {
        localStorage.setItem('hyperion_project', JSON.stringify(files));
    }

    function ansiToHtml(text) {
        if (!text) return '';
        const safe = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        return safe.replace(/\x1b\[(\d+)(;\d+)*m/g, (match, code) => {
            const colors = { 31: 'ansi-red', 32: 'ansi-green', 33: 'ansi-yellow', 34: 'ansi-blue', 0: '' };
            return `<span class="${colors[code] || 'ansi-white'}">`;
        }) + "</span>";
    }

    async function runCode() {
        const term = document.getElementById('terminal');
        const activeFile = files.find(f => f.id === activeFileId);
        term.innerHTML = `<div class="loading text-blue-400">âš¡ Compiling & Executing ${activeFile.name}...</div>`;
        
        const payload = {
            language: activeFile.lang,
            version: RUNTIMES[activeFile.lang]?.v || "*",
            files: files.map(f => ({ name: f.name, content: f.content })),
            stdin: document.getElementById('stdin-input').value
        };

        try {
            const res = await fetch('https://emkc.org/api/v2/piston/execute', {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            term.innerHTML = '';
            if (data.compile && data.compile.stderr) {
                term.innerHTML += `<div class="ansi-red">COMPILE ERROR:\n${ansiToHtml(data.compile.stderr)}</div>`;
            }
            
            const output = data.run.stdout + data.run.stderr;
            const truncated = output.length > 5000 ? output.substring(0, 5000) + "\n\n[Output Truncated...]" : output;
            term.innerHTML += `<div>${ansiToHtml(truncated)}</div>`;
            
            if (data.run.signal) term.innerHTML += `<div class="text-orange-500 mt-2">Process killed by signal: ${data.run.signal}</div>`;
        } catch (err) {
            term.innerHTML = `<div class="ansi-red">Network Error: Could not reach Piston API.</div>`;
        }
    }

    // Hotkeys
    window.addEventListener('keydown', e => {
        if (e.ctrlKey && e.key === 'Enter') { e.preventDefault(); runCode(); }
        if (e.ctrlKey && e.key === 's') { e.preventDefault(); takeSnapshot(); alert('Snapshot Saved!'); }
    });

    // Simple Resizer
    let isResizing = false;
    document.getElementById('resizer').onmousedown = () => isResizing = true;
    window.onmousemove = (e) => {
        if (!isResizing) return;
        const h = window.innerHeight - e.clientY;
        if (h > 100 && h < window.innerHeight * 0.8) {
            document.querySelector('.editor-container').style.gridTemplateRows = `1fr ${h}px`;
        }
    };
    window.onmouseup = () => isResizing = false;

    function clearConsole() { document.getElementById('terminal').innerHTML = ''; }

    function takeSnapshot() {
        let history = JSON.parse(localStorage.getItem('hyperion_history')) || [];
        history.unshift({ time: new Date().toISOString(), data: files });
        if (history.length > 10) history.pop();
        localStorage.setItem('hyperion_history', JSON.stringify(history));
    }

    function exportProject() {
        const blob = new Blob([JSON.stringify(files, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'hyperion_project.json'; a.click();
    }
</script>
</body>
</html>
