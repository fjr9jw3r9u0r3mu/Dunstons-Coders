<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nebula-X IDE | Dunstons-Coder</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&family=Fira+Code:wght@400;500&display=swap');
        :root { --bg: #050505; --panel: #0d0d0f; --accent: #10b981; --border: #1f1f23; --text: #f4f4f5; }
        body { background: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; height: 100vh; overflow: hidden; margin: 0; }
        
        /* UI Components */
        .glass { background: rgba(13, 13, 15, 0.7); backdrop-filter: blur(20px); border: 1px solid var(--border); }
        .sidebar-item-active { background: rgba(16, 185, 129, 0.1); color: var(--accent); border-left: 3px solid var(--accent); }
        .tab-active { color: var(--accent); border-bottom: 2px solid var(--accent); background: rgba(16, 185, 129, 0.05); }
        
        /* Custom Scroll */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
        
        /* Terminal Styling */
        pre { white-space: pre-wrap; word-wrap: break-word; font-family: 'Fira Code', monospace; font-size: 12px; }
        .std-out { color: #10b981; }
        .std-err { color: #ef4444; }
        .std-info { color: #71717a; }

        /* Animations */
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-ui { animation: fadeUp 0.3s ease-out; }
    </style>
</head>
<body class="flex flex-col">

    <header class="h-14 border-b border-[#1f1f23] flex items-center justify-between px-6 bg-black z-50">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-gradient-to-br from-emerald-400 to-green-600 rounded-lg flex items-center justify-center">
                    <i class="fa-solid fa-bolt-lightning text-black text-sm"></i>
                </div>
                <h1 class="font-bold text-xs tracking-[0.2em] uppercase italic">Nebula-<span class="text-emerald-500">X</span></h1>
            </div>
            
            <div class="h-6 w-px bg-zinc-800"></div>
            
            <nav class="flex items-center gap-4 text-[10px] font-bold text-gray-500 uppercase">
                <button onclick="openModal('projects')" class="hover:text-white transition">Projects</button>
                <button onclick="openModal('ai')" class="hover:text-emerald-400 transition"><i class="fa-solid fa-robot mr-1"></i> AI Assistant</button>
                <button onclick="openModal('settings')" class="hover:text-white transition">Settings</button>
            </nav>
        </div>

        <div class="flex items-center gap-6">
            <div class="flex flex-col items-end">
                <div class="text-[9px] font-black text-gray-500 uppercase tracking-widest">Mastery Level <span id="user-level" class="text-emerald-500">1</span></div>
                <div class="w-32 h-1 bg-[#1f1f23] rounded-full mt-1 overflow-hidden">
                    <div id="xp-bar" class="h-full bg-emerald-500 w-0 transition-all duration-700"></div>
                </div>
            </div>
            <button onclick="exportProject()" class="text-xs text-zinc-500 hover:text-white"><i class="fa-solid fa-file-export"></i></button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside id="sidebar" class="w-64 bg-black border-r border-[#1f1f23] flex flex-col transition-all duration-300 overflow-hidden">
            <div class="p-4 space-y-4">
                <button onclick="createNewFile()" class="w-full bg-emerald-500 hover:bg-emerald-400 text-black py-2.5 rounded-lg font-black text-[10px] uppercase shadow-lg shadow-emerald-500/10">
                    + New Source
                </button>
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-2.5 text-zinc-600 text-[10px]"></i>
                    <input type="text" id="file-search" placeholder="Quick Search (Ctrl+P)" oninput="renderFiles()" class="w-full bg-[#0d0d0f] border border-zinc-800 p-2 pl-8 rounded-md text-[10px] outline-none focus:border-emerald-500">
                </div>
            </div>

            <div class="flex-1 overflow-y-auto px-2 space-y-0.5" id="file-tree"></div>

            <div class="p-4 bg-[#0d0d0f] border-t border-[#1f1f23]">
                <button onclick="runCode()" id="run-btn" class="w-full bg-white text-black py-3 rounded-lg font-black text-xs uppercase hover:bg-emerald-500 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-play"></i> Run Code
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-[#050505] min-w-0">
            <div id="tabs-bar" class="flex bg-black border-b border-[#1f1f23] h-10 items-center px-2 gap-1 overflow-x-auto"></div>
            <div id="editor-container" class="flex-1"></div>
            
            <footer class="h-8 bg-black border-t border-[#1f1f23] flex items-center justify-between px-4 text-[9px] font-bold text-zinc-500">
                <div class="flex gap-4">
                    <span><i class="fa-solid fa-code-fork text-emerald-500 mr-1"></i> branch: main</span>
                    <span id="pos-info">Ln 1, Col 1</span>
                    <span id="char-info">0 chars</span>
                </div>
                <div class="flex gap-4">
                    <span class="text-emerald-500 cursor-pointer" onclick="toggleMinimap()">Minimap</span>
                    <span class="uppercase">Nebula Engine v26</span>
                </div>
            </footer>
        </main>

        <div id="resizer" class="w-1 bg-[#1f1f23] hover:bg-emerald-500 cursor-col-resize transition-colors"></div>
        <div id="output-panel" class="w-96 flex flex-col bg-black border-l border-[#1f1f23]">
            <div class="h-10 border-b border-[#1f1f23] flex items-center justify-between px-4 bg-[#0d0d0f]">
                <div class="flex gap-4 h-full">
                    <button onclick="switchOut('term')" id="tab-term" class="text-[9px] font-black text-emerald-500 border-b border-emerald-500 h-full uppercase">Terminal</button>
                    <button onclick="switchOut('web')" id="tab-web" class="text-[9px] font-black text-zinc-500 h-full uppercase">Live Preview</button>
                </div>
                <button onclick="clearConsole()" class="text-[9px] font-bold text-zinc-600 hover:text-white uppercase">Clear</button>
            </div>
            
            <div id="console-view" class="flex-1 p-4 overflow-y-auto bg-black scroll-smooth">
                <div id="terminal-output" class="font-mono text-xs"></div>
            </div>
            <div id="preview-view" class="flex-1 hidden bg-white">
                <iframe id="web-frame" class="w-full h-full border-none" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-6" onclick="closeModals()">
        <div id="modal-ai" class="glass w-full max-w-md rounded-2xl p-6 hidden" onclick="event.stopPropagation()">
            <h3 class="text-emerald-500 font-black uppercase text-xs mb-4">Nebula AI Assistant</h3>
            <div id="ai-chat" class="h-64 overflow-y-auto mb-4 text-[11px] space-y-3 p-2 bg-black/50 rounded-lg">
                <div class="text-zinc-500 italic">I can explain your code or find errors. What do you need?</div>
            </div>
            <div class="flex gap-2">
                <input type="text" id="ai-input" placeholder="Ask AI about this file..." class="flex-1 bg-black border border-zinc-800 p-2 rounded text-xs outline-none">
                <button onclick="askAI()" class="bg-emerald-600 px-4 py-2 rounded text-xs font-bold">Ask</button>
            </div>
        </div>
        <div id="modal-settings" class="glass w-full max-w-md rounded-2xl p-8 hidden" onclick="event.stopPropagation()">
            <h3 class="text-white font-black uppercase text-xs mb-6">IDE Preferences</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-[11px] text-zinc-400">Font Size</span>
                    <input type="range" min="10" max="24" value="15" oninput="updateFontSize(this.value)" class="accent-emerald-500">
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-[11px] text-zinc-400">Word Wrap</span>
                    <button onclick="toggleWrap()" class="bg-zinc-800 px-3 py-1 rounded text-[10px]">Toggle</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- IDE ENGINE STATE ---
        let editor, activeId, saveTimeout, minimapState = true;
        let xp = parseInt(localStorage.getItem('nebula_xp')) || 0;
        let db = JSON.parse(localStorage.getItem('nebula_db')) || {
            projects: {
                'Project Alpha': [
                    { id: '1', name: 'main.py', lang: 'python', content: 'print("Nebula-X Online.")' },
                    { id: '2', name: 'index.html', lang: 'html', content: '<h1>Hello Nebula</h1>' }
                ]
            },
            currentProject: 'Project Alpha'
        };

        const LANG_EXTS = { py: 'python', cpp: 'cpp', java: 'java', js: 'javascript', html: 'html', css: 'css', rs: 'rust', go: 'go', ts: 'typescript' };

        // --- CORE INIT ---
        window.onload = () => {
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
            require(['vs/editor/editor.main'], () => {
                initEditor();
                initResizer();
                initKeybinds();
                updateXP(0);
            });
        };

        function initEditor() {
            const projectFiles = db.projects[db.currentProject];
            const file = projectFiles[0];
            activeId = file.id;

            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: file.content,
                language: file.lang,
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 15,
                fontFamily: 'Fira Code',
                fontWeight: '500',
                minimap: { enabled: true },
                bracketPairColorization: { enabled: true },
                smoothScrolling: true,
                cursorBlinking: 'smooth',
                padding: { top: 20 }
            });

            editor.onDidChangeModelContent(() => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveCore, 500);
                updateStats();
            });

            editor.onDidChangeCursorPosition(e => {
                document.getElementById('pos-info').innerText = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
            });

            renderFiles();
            renderTabs();
        }

        // --- FEATURES ---
        function saveCore() {
            const file = db.projects[db.currentProject].find(x => x.id === activeId);
            if(file) {
                file.content = editor.getValue();
                localStorage.setItem('nebula_db', JSON.stringify(db));
                updateXP(1);
            }
        }

        async function runCode() {
            const f = db.projects[db.currentProject].find(x => x.id === activeId);
            const term = document.getElementById('terminal-output');
            
            if(f.lang === 'html') {
                switchOut('web');
                document.getElementById('web-frame').srcdoc = f.content;
                return;
            }

            switchOut('term');
            term.innerHTML += `<div class="std-info">[${new Date().toLocaleTimeString()}] Executing ${f.name}...</div>`;
            
            try {
                const res = await fetch('https://emkc.org/api/v2/piston/execute', {
                    method: 'POST',
                    body: JSON.stringify({ language: f.lang, version: "*", files: [{ content: f.content }] })
                });
                const out = await res.json();
                if(out.run) {
                    if(out.run.stdout) term.innerHTML += `<pre class="std-out">${out.run.stdout}</pre>`;
                    if(out.run.stderr) term.innerHTML += `<pre class="std-err">${out.run.stderr}</pre>`;
                    updateXP(25);
                }
            } catch (e) { term.innerHTML += `<div class="std-err">Execution Failed: Connection Timeout</div>`; }
            
            term.parentElement.scrollTop = term.parentElement.scrollHeight;
        }

        function createNewFile() {
            const name = prompt("Filename (e.g. app.js):", "script.py");
            if(!name) return;
            const ext = name.split('.').pop();
            const id = Date.now().toString();
            db.projects[db.currentProject].push({
                id, name, lang: LANG_EXTS[ext] || 'plaintext', content: ''
            });
            switchFile(id);
        }

        function switchFile(id) {
            saveCore();
            activeId = id;
            const f = db.projects[db.currentProject].find(x => x.id === id);
            editor.setValue(f.content);
            monaco.editor.setModelLanguage(editor.getModel(), f.lang);
            renderFiles();
            renderTabs();
        }

        // --- UI ---
        function renderFiles() {
            const tree = document.getElementById('file-tree');
            const filter = document.getElementById('file-search').value.toLowerCase();
            tree.innerHTML = '';
            
            db.projects[db.currentProject].forEach(f => {
                if(!f.name.toLowerCase().includes(filter)) return;
                const active = f.id === activeId;
                tree.innerHTML += `
                    <div onclick="switchFile('${f.id}')" class="group px-3 py-2 rounded-md text-[11px] font-bold cursor-pointer flex justify-between items-center transition-all ${active ? 'sidebar-item-active' : 'text-zinc-500 hover:bg-zinc-900'}">
                        <span><i class="fa-solid fa-file-code mr-2 opacity-50"></i>${f.name}</span>
                        <i onclick="deleteFile(event, '${f.id}')" class="fa-solid fa-trash opacity-0 group-hover:opacity-100 hover:text-red-500 text-[9px]"></i>
                    </div>`;
            });
        }

        function renderTabs() {
            const bar = document.getElementById('tabs-bar');
            bar.innerHTML = '';
            db.projects[db.currentProject].forEach(f => {
                const active = f.id === activeId;
                bar.innerHTML += `
                    <div onclick="switchFile('${f.id}')" class="px-4 py-2 text-[10px] font-black cursor-pointer uppercase transition-all flex items-center gap-2 ${active ? 'tab-active' : 'text-zinc-600 hover:text-zinc-300'}">
                        ${f.name}
                    </div>`;
            });
        }

        function switchOut(t) {
            document.getElementById('console-view').classList.toggle('hidden', t !== 'term');
            document.getElementById('preview-view').classList.toggle('hidden', t !== 'web');
            document.getElementById('tab-term').className = t === 'term' ? "text-[9px] font-black text-emerald-500 border-b border-emerald-500 h-full uppercase" : "text-[9px] font-black text-zinc-500 h-full uppercase";
            document.getElementById('tab-web').className = t === 'web' ? "text-[9px] font-black text-emerald-500 border-b border-emerald-500 h-full uppercase" : "text-[9px] font-black text-zinc-500 h-full uppercase";
        }

        // --- UTILS ---
        function updateXP(v) {
            xp += v; localStorage.setItem('nebula_xp', xp);
            document.getElementById('user-level').innerText = Math.floor(xp / 500) + 1;
            document.getElementById('xp-bar').style.width = (xp % 500) / 5 + '%';
        }

        function updateStats() {
            document.getElementById('char-info').innerText = `${editor.getValue().length} chars`;
        }

        function initKeybinds() {
            window.addEventListener('keydown', e => {
                if(e.ctrlKey && e.key === 's') { e.preventDefault(); saveCore(); }
                if(e.ctrlKey && e.key === 'p') { e.preventDefault(); document.getElementById('file-search').focus(); }
                if(e.ctrlKey && e.key === 'Enter') { e.preventDefault(); runCode(); }
            });
        }

        function toggleMinimap() {
            minimapState = !minimapState;
            editor.updateOptions({ minimap: { enabled: minimapState } });
        }

        function initResizer() {
            const resizer = document.getElementById('resizer'), panel = document.getElementById('output-panel');
            resizer.addEventListener('mousedown', e => {
                const move = md => {
                    const w = window.innerWidth - md.clientX;
                    if(w > 150 && w < 800) panel.style.width = w + 'px';
                };
                document.addEventListener('mousemove', move);
                document.addEventListener('mouseup', () => document.removeEventListener('mousemove', move));
            });
        }

        async function askAI() {
            const input = document.getElementById('ai-input');
            const chat = document.getElementById('ai-chat');
            if(!input.value) return;
            
            chat.innerHTML += `<div class="text-white font-bold">You: ${input.value}</div>`;
            chat.innerHTML += `<div class="text-emerald-500">Nebula-AI: Let me check your ${activeId} content... Based on your code, I suggest checking your syntax on line 1. (Simulated AI Analysis)</div>`;
            input.value = '';
            chat.scrollTop = chat.scrollHeight;
        }

        function openModal(id) { 
            document.getElementById('modal-overlay').classList.remove('hidden'); 
            document.getElementById(`modal-${id}`).classList.remove('hidden'); 
        }
        function closeModals() { 
            document.getElementById('modal-overlay').classList.add('hidden'); 
            document.querySelectorAll('[id^="modal-"]').forEach(m => m.classList.add('hidden')); 
        }
        function clearConsole() { document.getElementById('terminal-output').innerHTML = ''; }
        function deleteFile(e, id) { e.stopPropagation(); if(confirm('Delete file?')) { db.projects[db.currentProject] = db.projects[db.currentProject].filter(f => f.id !== id); renderFiles(); renderTabs(); } }
    </script>
</body>
</html>
