<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dunstons-Coder v16 | Omnipotent</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>

    <style>
        /* CORE VARIABLES & RESET */
        :root {
            --bg-dark: #09090b;
            --bg-panel: #18181b;
            --accent: #22c55e;
            --accent-hover: #16a34a;
            --danger: #ef4444;
            --text-main: #e4e4e7;
            --text-dim: #71717a;
            --border: #27272a;
        }

        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', system-ui, sans-serif; overflow: hidden; height: 100vh; }
        
        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* EDITOR OVERRIDES */
        .monaco-editor { padding-top: 10px; }
        
        /* TERMINAL & PREVIEW */
        #terminal-output { font-family: 'Fira Code', monospace; white-space: pre-wrap; font-size: 13px; line-height: 1.5; }
        .ansi-red { color: #f87171; }
        .ansi-green { color: #4ade80; }
        .ansi-blue { color: #60a5fa; }
        .ansi-yellow { color: #facc15; }

        /* PREVIEW FRAME */
        iframe { background: white; width: 100%; height: 100%; border: none; }

        /* ANIMATIONS */
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-anim { animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col h-screen select-none">

    <header class="h-14 bg-[#18181b] border-b border-[#27272a] flex items-center justify-between px-4 z-20">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-green-600 rounded flex items-center justify-center shadow-[0_0_15px_rgba(34,197,94,0.4)]">
                <i class="fa-solid fa-code text-white font-bold"></i>
            </div>
            <h1 class="font-bold text-lg tracking-tight text-white">DUNSTONS-<span class="text-green-500">CODER</span></h1>
            <span class="text-[10px] bg-[#27272a] px-2 py-0.5 rounded text-gray-400 font-mono">v16.0 OMNIPOTENT</span>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="openMissionControl()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-2 border border-indigo-500 shadow-sm">
                <i class="fa-solid fa-crosshairs"></i> MISSIONS
            </button>
            <div class="h-6 w-px bg-[#3f3f46]"></div>
            <button onclick="saveProject()" class="text-gray-400 hover:text-white transition px-2"><i class="fa-solid fa-save"></i></button>
            <button onclick="toggleLayout()" class="text-gray-400 hover:text-white transition px-2"><i class="fa-solid fa-table-columns"></i></button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-64 bg-[#09090b] border-r border-[#27272a] flex flex-col flex-shrink-0">
            <div class="p-3 border-b border-[#27272a] flex gap-2">
                <button onclick="createNewFile()" class="flex-1 bg-[#27272a] hover:bg-[#3f3f46] text-xs py-2 rounded text-white transition font-medium">
                    <i class="fa-solid fa-plus mr-1"></i> New File
                </button>
            </div>
            
            <div id="file-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>

            <div class="p-3 border-t border-[#27272a] bg-[#18181b] flex flex-col gap-3">
                <div>
                    <label class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-1 block">Language</label>
                    <select id="lang-select" onchange="updateLang()" class="w-full bg-[#27272a] text-xs text-white p-2 rounded outline-none border border-[#3f3f46] focus:border-green-500 transition">
                        <option value="python">üêç Python 3.10</option>
                        <option value="cpp">‚öôÔ∏è C++ (GCC + Threads)</option>
                        <option value="java">‚òï Java 15</option>
                        <option value="javascript">‚ö° Node.js 18</option>
                        <option value="lua">üåô Lua 5.4</option>
                        <option value="html">üåê HTML5 (Web Preview)</option>
                    </select>
                </div>
                
                <input type="text" id="stdin-input" placeholder="Stdin arguments..." class="w-full bg-[#09090b] border border-[#3f3f46] text-xs p-2 rounded text-white outline-none focus:border-green-500">

                <button id="run-btn" onclick="runCode()" class="w-full bg-green-600 hover:bg-green-500 text-white py-2.5 rounded text-sm font-bold shadow-lg shadow-green-900/20 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-play"></i> RUN CODE
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-[#1e1e1e]">
            <div id="tabs-bar" class="flex bg-[#18181b] border-b border-[#27272a] overflow-x-auto"></div>
            
            <div id="editor-container" class="flex-1 relative"></div>
        </main>

        <div id="output-panel" class="w-1/3 bg-[#09090b] border-l border-[#27272a] flex flex-col flex-shrink-0 transition-all duration-300">
            <div class="h-9 bg-[#18181b] border-b border-[#27272a] flex items-center justify-between px-3">
                <div class="flex gap-4 text-xs font-bold text-gray-400">
                    <button onclick="showTab('console')" id="btn-console" class="text-white border-b-2 border-green-500 pb-[10px] pt-[8px]">TERMINAL</button>
                    <button onclick="showTab('webview')" id="btn-webview" class="hover:text-white pb-[10px] pt-[8px]">WEB PREVIEW</button>
                </div>
                <button onclick="clearConsole()" class="text-xs text-gray-500 hover:text-white"><i class="fa-solid fa-trash"></i></button>
            </div>

            <div id="view-console" class="flex-1 flex flex-col h-full overflow-hidden">
                <div id="terminal-output" class="flex-1 p-3 overflow-y-auto text-gray-300 font-mono text-sm selection:bg-green-900">
                    <div class="text-gray-500 italic">Ready for execution...</div>
                </div>
            </div>

            <div id="view-webview" class="flex-1 hidden h-full bg-white">
                <iframe id="web-frame"></iframe>
            </div>
        </div>

    </div>

    <div id="mission-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[#18181b] w-full max-w-2xl rounded-xl border border-[#27272a] shadow-2xl modal-anim flex flex-col max-h-[80vh]">
            <div class="p-5 border-b border-[#27272a] flex justify-between items-center">
                <h2 class="text-xl font-bold text-white"><i class="fa-solid fa-trophy text-yellow-500 mr-2"></i>Mission Control</h2>
                <button onclick="closeMissionControl()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-4">
                
                <div class="bg-[#27272a] p-4 rounded-lg border border-[#3f3f46] hover:border-green-500 transition cursor-pointer group" onclick="loadMission('easy')">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-green-400">Cadet: The FizzBuzz Test</h3>
                        <span class="text-[10px] bg-green-900 text-green-300 px-2 py-1 rounded">EASY</span>
                    </div>
                    <p class="text-sm text-gray-400 group-hover:text-gray-300">Write a program that prints numbers 1 to 100. Multiples of 3 print "Fizz", 5 print "Buzz".</p>
                </div>

                <div class="bg-[#27272a] p-4 rounded-lg border border-[#3f3f46] hover:border-blue-500 transition cursor-pointer group" onclick="loadMission('medium')">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-blue-400">Pilot: Palindrome Detector</h3>
                        <span class="text-[10px] bg-blue-900 text-blue-300 px-2 py-1 rounded">MEDIUM</span>
                    </div>
                    <p class="text-sm text-gray-400 group-hover:text-gray-300">Check if a given string is a palindrome (reads the same forwards and backwards), ignoring spaces/case.</p>
                </div>

                <div class="bg-[#27272a] p-4 rounded-lg border border-[#3f3f46] hover:border-red-500 transition cursor-pointer group" onclick="loadMission('hard')">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-red-400">Commander: N-Queens Problem</h3>
                        <span class="text-[10px] bg-red-900 text-red-300 px-2 py-1 rounded">HARD</span>
                    </div>
                    <p class="text-sm text-gray-400 group-hover:text-gray-300">Place N chess queens on an N√óN chessboard so that no two queens attack each other.</p>
                </div>
                
                <div class="bg-[#27272a] p-4 rounded-lg border border-[#3f3f46] hover:border-purple-500 transition cursor-pointer group" onclick="loadMission('cpp_threads')">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-purple-400">SpecOps: Multi-threaded Matrix</h3>
                        <span class="text-[10px] bg-purple-900 text-purple-300 px-2 py-1 rounded">C++ ONLY</span>
                    </div>
                    <p class="text-sm text-gray-400 group-hover:text-gray-300">Calculate matrix multiplication using 4 parallel threads in C++. (Tests the Linker Fix)</p>
                </div>

            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // SYSTEM CORE
        // ==========================================
        let editor;
        let files = [];
        let activeId = null;

        // Default Project State
        const DEFAULT_STATE = [
            { 
                id: 'init_1', 
                name: 'main.cpp', 
                lang: 'cpp', 
                content: '#include <iostream>\n#include <thread>\n#include <vector>\n\nvoid worker(int id) {\n    std::cout << "Worker " << id << " is running on a separate thread!\\n";\n}\n\nint main() {\n    std::vector<std::thread> threads;\n    for(int i = 0; i < 5; ++i) {\n        threads.emplace_back(worker, i);\n    }\n    for(auto& t : threads) t.join();\n    std::cout << "All threads finished safely. Linker Fixed." << std::endl;\n    return 0;\n}' 
            }
        ];

        // Initialization
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('dc_v16_omnipotent');
            files = saved ? JSON.parse(saved) : DEFAULT_STATE;
            if(files.length === 0) files = DEFAULT_STATE;
            activeId = files[0].id;

            initMonaco();
        });

        function initMonaco() {
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
            require(['vs/editor/editor.main'], function() {
                editor = monaco.editor.create(document.getElementById('editor-container'), {
                    value: files[0].content,
                    language: getMonacoLang(files[0].lang),
                    theme: 'vs-dark',
                    automaticLayout: true,
                    fontSize: 15,
                    fontFamily: 'Fira Code',
                    minimap: { enabled: false },
                    scrollBeyondLastLine: false,
                    padding: { top: 16, bottom: 16 }
                });

                editor.onDidChangeModelContent(() => {
                    const f = files.find(x => x.id === activeId);
                    if(f) {
                        f.content = editor.getValue();
                        localStorage.setItem('dc_v16_omnipotent', JSON.stringify(files));
                    }
                });

                renderUI();
            });
        }

        // ==========================================
        // UI & LOGIC
        // ==========================================
        function renderUI() {
            renderFileList();
            renderTabs();
            
            const activeFile = files.find(f => f.id === activeId);
            if(activeFile) {
                document.getElementById('lang-select').value = activeFile.lang;
                // If HTML, show webview tab automatically
                if(activeFile.lang === 'html') showTab('webview');
                else showTab('console');
            }
        }

        function renderFileList() {
            const list = document.getElementById('file-list');
            list.innerHTML = '';
            files.forEach(f => {
                const el = document.createElement('div');
                el.className = `flex justify-between items-center p-2 rounded cursor-pointer text-xs ${f.id === activeId ? 'bg-[#27272a] text-white border-l-2 border-green-500' : 'text-gray-400 hover:bg-[#18181b]'}`;
                el.onclick = () => switchFile(f.id);
                el.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <i class="${getFileIcon(f.lang)} w-4 text-center"></i>
                        <span class="truncate">${f.name}</span>
                    </div>
                    <button onclick="deleteFile(event, '${f.id}')" class="text-gray-600 hover:text-red-500 px-1"><i class="fa-solid fa-times"></i></button>
                `;
                list.appendChild(el);
            });
        }

        function renderTabs() {
            const bar = document.getElementById('tabs-bar');
            bar.innerHTML = '';
            files.forEach(f => {
                const tab = document.createElement('div');
                tab.className = `px-4 py-2 text-xs border-r border-[#27272a] cursor-pointer flex items-center gap-2 flex-shrink-0 ${f.id === activeId ? 'bg-[#1e1e1e] text-green-400 border-t-2 border-t-green-500' : 'bg-[#18181b] text-gray-500 hover:text-gray-300'}`;
                tab.innerText = f.name;
                tab.onclick = () => switchFile(f.id);
                bar.appendChild(tab);
            });
        }

        function switchFile(id) {
            activeId = id;
            const f = files.find(x => x.id === id);
            if(!editor || !f) return;
            
            const model = editor.getModel();
            monaco.editor.setModelLanguage(model, getMonacoLang(f.lang));
            editor.setValue(f.content);
            renderUI();
        }

        function createNewFile() {
            const name = prompt("Filename (e.g. script.js, index.html, main.cpp):", "new.py");
            if(!name) return;
            
            let lang = 'python';
            if(name.endsWith('.js')) lang = 'javascript';
            if(name.endsWith('.cpp')) lang = 'cpp';
            if(name.endsWith('.java')) lang = 'java';
            if(name.endsWith('.html')) lang = 'html';
            if(name.endsWith('.lua')) lang = 'lua';

            const newFile = { id: Date.now().toString(), name, lang, content: '' };
            files.push(newFile);
            switchFile(newFile.id);
        }

        function deleteFile(e, id) {
            e.stopPropagation();
            if(files.length <= 1) return alert("Cannot delete last file.");
            if(!confirm("Delete file?")) return;
            files = files.filter(f => f.id !== id);
            if(activeId === id) activeId = files[0].id;
            switchFile(activeId);
        }

        function updateLang() {
            const f = files.find(x => x.id === activeId);
            f.lang = document.getElementById('lang-select').value;
            switchFile(activeId); // Update syntax highlighting
        }

        // ==========================================
        // EXECUTION ENGINE (THE FIX)
        // ==========================================
        async function runCode() {
            const f = files.find(x => x.id === activeId);
            const btn = document.getElementById('run-btn');
            
            // 1. HTML WEBVIEW HANDLER
            if(f.lang === 'html') {
                showTab('webview');
                const frame = document.getElementById('web-frame');
                frame.srcdoc = f.content; // Direct injection
                return;
            }

            // 2. PISTON BACKEND HANDLER
            showTab('console');
            const term = document.getElementById('terminal-output');
            term.innerHTML = '<div class="text-yellow-500"><i class="fa-solid fa-circle-notch spin"></i> Compiling & Executing...</div>';
            btn.disabled = true;

            const stdin = document.getElementById('stdin-input').value;
            
            // PREPARE PAYLOAD
            let payload = {
                language: f.lang,
                version: "*",
                files: [{ content: f.content }],
                stdin: stdin,
                args: []
            };

            // *** THE C++ GOD FIX ***
            // We create a custom bash wrapper to ensure pthread linking works
            if(f.lang === 'cpp') {
                payload.language = "bash"; // Trick: Run as bash
                payload.files = [
                    {
                        name: "run.sh",
                        content: `g++ -pthread main.cpp -o main && ./main`
                    },
                    {
                        name: "main.cpp",
                        content: f.content
                    }
                ];
            }
            
            // Java Fix (Main class)
            if(f.lang === 'java') {
                // Ensure filename matches class (API limitation workaround)
                payload.files[0].name = "Main.java"; 
            }

            try {
                const res = await fetch('https://emkc.org/api/v2/piston/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                term.innerHTML = ''; // Clear loading
                
                if(data.run) {
                    if(data.run.stdout) term.innerHTML += `<span class="text-white">${escapeHtml(data.run.stdout)}</span>`;
                    if(data.run.stderr) term.innerHTML += `<span class="ansi-red">${escapeHtml(data.run.stderr)}</span>`;
                    if(!data.run.stdout && !data.run.stderr) term.innerHTML += '<span class="text-gray-500">Program exited silently.</span>';
                } else {
                    term.innerHTML = `<span class="ansi-red">API Error: ${data.message}</span>`;
                }

            } catch(e) {
                term.innerHTML = `<span class="ansi-red">Network Error: ${e.message}</span>`;
            } finally {
                btn.disabled = false;
            }
        }

        // ==========================================
        // MISSIONS & UTILS
        // ==========================================
        function openMissionControl() { document.getElementById('mission-modal').classList.remove('hidden'); }
        function closeMissionControl() { document.getElementById('mission-modal').classList.add('hidden'); }

        const MISSIONS = {
            easy: { name: 'mission_fizzbuzz.py', lang: 'python', content: 'def fizzbuzz(n):\n    # TODO: Print 1 to n. \n    # If div by 3 -> "Fizz", by 5 -> "Buzz", both -> "FizzBuzz"\n    pass\n\nfizzbuzz(15)' },
            medium: { name: 'mission_palindrome.js', lang: 'javascript', content: 'function isPalindrome(str) {\n    // TODO: Return true if str reads same backwards\n    // Ignore case and spaces\n    return false;\n}\n\nconsole.log(isPalindrome("Race Car"));' },
            hard: { name: 'mission_nqueens.cpp', lang: 'cpp', content: '#include <iostream>\n#include <vector>\n\n// TODO: Solve N-Queens for N=8\nint main() {\n    std::cout << "Implement Backtracking here..." << std::endl;\n    return 0;\n}' },
            cpp_threads: { name: 'mission_matrix.cpp', lang: 'cpp', content: '#include <iostream>\n#include <vector>\n#include <thread>\n\n// THIS TESTS THE LINKER FIX\nvoid multiply_row() {\n    // TODO: Calculation\n}\n\nint main() {\n    std::cout << "Spawning threads..." << std::endl;\n    std::thread t1([]{ std::cout << "Thread 1 Active\\n"; });\n    std::thread t2([]{ std::cout << "Thread 2 Active\\n"; });\n    t1.join();\n    t2.join();\n    return 0;\n}' }
        };

        function loadMission(key) {
            const m = MISSIONS[key];
            const newFile = { id: Date.now().toString(), name: m.name, lang: m.lang, content: m.content };
            files.push(newFile);
            closeMissionControl();
            switchFile(newFile.id);
        }

        function showTab(type) {
            document.getElementById('view-console').classList.add('hidden');
            document.getElementById('view-webview').classList.add('hidden');
            document.getElementById('btn-console').classList.remove('text-white', 'border-b-2', 'border-green-500');
            document.getElementById('btn-console').classList.add('text-gray-400');
            document.getElementById('btn-webview').classList.remove('text-white', 'border-b-2', 'border-green-500');
            document.getElementById('btn-webview').classList.add('text-gray-400');

            if(type === 'console') {
                document.getElementById('view-console').classList.remove('hidden');
                document.getElementById('btn-console').classList.add('text-white', 'border-b-2', 'border-green-500');
                document.getElementById('btn-console').classList.remove('text-gray-400');
            } else {
                document.getElementById('view-webview').classList.remove('hidden');
                document.getElementById('btn-webview').classList.add('text-white', 'border-b-2', 'border-green-500');
                document.getElementById('btn-webview').classList.remove('text-gray-400');
            }
        }

        function clearConsole() { document.getElementById('terminal-output').innerHTML = ''; }
        function saveProject() { localStorage.setItem('dc_v16_omnipotent', JSON.stringify(files)); alert("Saved!"); }
        
        // Helper
        function getMonacoLang(l) {
            if(l === 'js' || l === 'javascript') return 'javascript';
            if(l === 'cpp' || l === 'c++') return 'cpp';
            if(l === 'py' || l === 'python') return 'python';
            return l;
        }
        function getFileIcon(l) {
            if(l.includes('py')) return 'fa-brands fa-python';
            if(l.includes('js')) return 'fa-brands fa-js';
            if(l.includes('java')) return 'fa-brands fa-java';
            if(l.includes('html')) return 'fa-brands fa-html5';
            return 'fa-solid fa-file-code';
        }
        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

    </script>
</body>
</html>
