// ==UserScript==
// @name         Omega Chess Analyst
// @namespace    http://tampermonkey.net/
// @version      2.0
// @description  Local Stockfish analysis integration
// @author       Dunstons-Coder
// @match        https://www.chess.com/play/*
// @match        https://www.chess.com/game/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // 1. Load Stockfish from a CDN
    const sfWorker = new Worker('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');
    
    sfWorker.onmessage = function(e) {
        if (e.data.includes('bestmove')) {
            const move = e.data.split(' ')[1];
            console.log('%c Omega Analysis: ' + move, 'color: #10b981; font-weight: bold;');
            drawHighlight(move.substring(0, 2), move.substring(2, 4));
        }
    };

    // 2. Initialize Engine
    sfWorker.postMessage('uci');
    sfWorker.postMessage('setoption name Skill Level value 20');

    // 3. Highlight Function
    function drawHighlight(from, to) {
        // Remove old highlights
        document.querySelectorAll('.omega-move').forEach(el => el.remove());
        
        const board = document.querySelector('chess-board');
        if (!board) return;

        [from, to].forEach(coord => {
            const files = {a:1, b:2, c:3, d:4, e:5, f:6, g:7, h:8};
            const sqClass = `square-${files[coord[0]]}${coord[1]}`;
            
            const hl = document.createElement('div');
            hl.className = `highlight omega-move ${sqClass}`;
            hl.style.cssText = `background: #10b981; opacity: 0.6; z-index: 0;`;
            board.appendChild(hl);
        });
    }

    // 4. Observer to detect board changes
    const observer = new MutationObserver(() => {
        // Logic to extract FEN from Chess.com's internal game state
        // and send to worker: sfWorker.postMessage('position fen ' + currentFen);
        // sfWorker.postMessage('go depth 15');
    });

    const boardNode = document.querySelector('chess-board');
    if (boardNode) observer.observe(boardNode, { attributes: true, subtree: true });

})();
