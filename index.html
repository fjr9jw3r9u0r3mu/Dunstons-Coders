<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dunstons-Coder | World-Class Student IDE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.43.0/min/vs/editor/editor.main.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg: #05070a; --panel: #0d1117; --accent: #00ff41; 
            --border: #2b3238; --text: #e6edf3; --tab-active: #1e1e1e;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { height: 100%; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow: hidden; }

        /* UI GRID */
        .app-container { display: grid; grid-template-rows: 50px 1fr 220px; height: 100vh; }

        /* HEADER & TOOLBAR */
        header { background: var(--panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; }
        .logo { font-weight: 900; color: var(--accent); font-size: 18px; letter-spacing: 1px; }
        .toolbar { display: flex; gap: 8px; }

        /* TABS SYSTEM */
        .tabs-bar { background: #090c10; display: flex; overflow-x: auto; border-bottom: 1px solid var(--border); }
        .tab { 
            padding: 8px 20px; font-size: 12px; cursor: pointer; border-right: 1px solid var(--border); 
            display: flex; align-items: center; gap: 10px; background: #161b22; transition: 0.2s;
        }
        .tab.active { background: var(--tab-active); border-bottom: 2px solid var(--accent); }
        .tab:hover { background: #1f242c; }

        /* MAIN AREA */
        .main-workspace { display: flex; height: 100%; overflow: hidden; }
        #sidebar { width: 200px; background: var(--panel); border-right: 1px solid var(--border); padding: 15px; }
        #editor-target { flex: 1; height: 100%; }

        /* OUTPUT AREA */
        #console-container { background: #000; display: flex; flex-direction: column; border-top: 1px solid var(--border); }
        .console-header { 
            background: #0d1117; padding: 5px 15px; font-size: 11px; font-weight: bold; 
            display: flex; justify-content: space-between; color: var(--accent);
        }
        #output-terminal { flex: 1; padding: 15px; font-family: 'Consolas', monospace; font-size: 13px; overflow-y: auto; color: #fff; white-space: pre-wrap; }

        /* BUTTONS */
        .btn { 
            background: #21262d; color: var(--text); border: 1px solid var(--border); padding: 6px 12px; 
            border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; transition: 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .btn:hover { border-color: var(--accent); background: #30363d; }
        .btn-run { background: var(--accent); color: #000; border: none; padding: 6px 20px; }
        .btn-run:hover { background: #00cc33; transform: translateY(-1px); }

        /* TOOLTIPS & ONBOARDING */
        [title]:hover::after {
            content: attr(title); position: absolute; top: 45px; background: #30363d; padding: 5px 10px;
            border-radius: 4px; font-size: 10px; z-index: 99; white-space: nowrap;
        }

        /* JAVA LOGIC WARNING */
        .java-hint { font-size: 10px; color: #8b949e; margin-top: 10px; line-height: 1.3; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="logo">DUNSTONS-CODER <small style="font-size:9px; opacity:0.5">V11.0 PRO</small></div>
        <div class="toolbar">
            <button class="btn" title="Create a shareable link" onclick="shareProject()"><i class="fa-solid fa-share-nodes"></i> SHARE</button>
            <button class="btn" title="Download source" onclick="downloadProject()"><i class="fa-solid fa-download"></i> EXPORT</button>
            <button class="btn" title="Toggle Light/Dark" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i></button>
            <button class="btn btn-run" title="Execute Code (Ctrl+Enter)" onclick="runProject()">RUN <i class="fa-solid fa-play"></i></button>
        </div>
    </header>

    <div class="main-workspace">
        <aside id="sidebar">
            <div style="font-size:11px; font-weight:bold; margin-bottom:10px; opacity:0.6">FILES</div>
            <div id="file-list"></div>
            <button class="btn" style="width:100%; margin-top:10px;" onclick="createNewFile()">+ New File</button>
            
            <div class="java-hint">
                <strong>Pro Tip (Java):</strong><br>Always name your main class <code>Main</code> for the compiler to work.
            </div>
        </aside>

        <div style="flex:1; display:flex; flex-direction:column;">
            <div class="tabs-bar" id="tabs-bar"></div>
            <div id="editor-target"></div>
        </div>
    </div>

    <div id="console-container">
        <div class="console-header">
            <span>CONSOLE OUTPUT</span>
            <span onclick="clearOutput()" style="cursor:pointer; opacity:0.5">CLEAR</span>
        </div>
        <div id="output-terminal">Ready. Select a file to begin coding...</div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
<script>
    let editor, files = {}, activeFile = 'index.html';
    
    // 5. STARTER TEMPLATES
    const TEMPLATES = {
        'index.html': { lang: 'html', content: '<h1>Hello Dunston!</h1>\n<p>Start your web project.</p>' },
        'Main.java': { lang: 'java', content: 'public class Main {\n    public static void main(String[] args) {\n        System.out.println("Java Engine Fixed!");\n    }\n}' },
        'script.py': { lang: 'python', content: 'import math\nprint(f"PI is {math.pi}")\nprint("Python is ready.")' },
        'logic.lua': { lang: 'lua', content: 'print("Hello from Lua!")' }
    };

    // Initialize System
    files = JSON.parse(localStorage.getItem('dc_files')) || TEMPLATES;

    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.43.0/min/vs' }});
    require(['vs/editor/editor.main'], function() {
        editor = monaco.editor.create(document.getElementById('editor-target'), {
            theme: 'vs-dark',
            automaticLayout: true,
            fontSize: 14,
            minimap: { enabled: false },
            padding: { top: 15 }
        });

        // 6. KEYBOARD SHORTCUTS
        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runProject);
        editor.onDidChangeModelContent(() => {
            files[activeFile].content = editor.getValue();
            localStorage.setItem('dc_files', JSON.stringify(files));
        });

        renderTabs();
        switchFile(Object.keys(files)[0]);
        checkURLShare();
    });

    // 1. JAVA FIX & 7. SECURITY EXECUTION
    async function runProject() {
        const out = document.getElementById('output-terminal');
        const file = files[activeFile];
        out.innerHTML = `<span style="color:gray">> Building ${activeFile}...</span>\n`;

        if (file.lang === 'html') {
            const win = window.open();
            win.document.write(file.content);
            out.innerHTML += `> Web preview opened in new window.`;
            return;
        }

        try {
            const res = await fetch('https://emkc.org/api/v2/piston/execute', {
                method: 'POST',
                body: JSON.stringify({
                    language: file.lang,
                    version: "*",
                    files: [{ name: activeFile, content: file.content }]
                })
            });
            const data = await res.json();
            const result = data.run.stdout || data.run.stderr || "Program finished with no output.";
            out.innerHTML = `<span style="${data.run.stderr ? 'color:#ff6b6b' : ''}">${result}</span>`;
        } catch (e) {
            out.innerHTML = `<span style="color:red">Execution Error: System core unreachable.</span>`;
        }
    }

    // 3. PROJECT MANAGEMENT
    function renderTabs() {
        const bar = document.getElementById('tabs-bar');
        const list = document.getElementById('file-list');
        bar.innerHTML = ''; list.innerHTML = '';
        
        Object.keys(files).forEach(name => {
            // Render Tab
            const tab = document.createElement('div');
            tab.className = `tab ${name === activeFile ? 'active' : ''}`;
            tab.innerHTML = `<span>${name}</span> <i class="fa-solid fa-xmark" style="font-size:10px" onclick="deleteFile('${name}')"></i>`;
            tab.onclick = (e) => { if(e.target.tagName !== 'I') switchFile(name); };
            bar.appendChild(tab);

            // Render Sidebar List
            const item = document.createElement('div');
            item.style = `padding:5px; font-size:12px; cursor:pointer; color:${name === activeFile ? 'var(--accent)' : 'inherit'}`;
            item.innerHTML = `<i class="fa-regular fa-file"></i> ${name}`;
            item.onclick = () => switchFile(name);
            list.appendChild(item);
        });
    }

    function switchFile(name) {
        activeFile = name;
        editor.setValue(files[name].content);
        const monacoLang = files[name].lang === 'java' ? 'java' : (files[name].lang === 'python' ? 'python' : 'html');
        monaco.editor.setModelLanguage(editor.getModel(), monacoLang);
        renderTabs();
    }

    function createNewFile() {
        const name = prompt("Filename (e.g. main.py, test.java):");
        if (!name) return;
        const ext = name.split('.').pop();
        const langMap = { 'py': 'python', 'java': 'java', 'html': 'html', 'lua': 'lua', 'cpp': 'cpp' };
        files[name] = { lang: langMap[ext] || 'text', content: '' };
        switchFile(name);
    }

    // 8. ADVANCED FEATURES: SHARE VIA URL
    function shareProject() {
        const state = btoa(JSON.stringify(files));
        const url = window.location.origin + window.location.pathname + "?code=" + state;
        navigator.clipboard.writeText(url);
        alert("Project link copied to clipboard! Anyone with this link can see your code.");
    }

    function checkURLShare() {
        const params = new URLSearchParams(window.location.search);
        if (params.has('code')) {
            try {
                files = JSON.parse(atob(params.get('code')));
                renderTabs();
                switchFile(Object.keys(files)[0]);
            } catch(e) { console.error("Invalid share link"); }
        }
    }

    function downloadProject() {
        const blob = new Blob([editor.getValue()], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = activeFile;
        a.click();
    }

    function toggleTheme() {
        const current = editor._themeService._theme.themeName;
        editor.updateOptions({ theme: current === 'vs-dark' ? 'vs' : 'vs-dark' });
    }

    function clearOutput() { document.getElementById('output-terminal').innerHTML = ''; }
</script>
</body>
</html>
