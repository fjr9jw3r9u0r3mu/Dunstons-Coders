/**
 * OMEGA v25 ULTRA - ENGINE CORE
 */

let editor, activeId, saveTimeout;
let xp = parseInt(localStorage.getItem('omega_xp')) || 0;

// Project Data Management
let projectData = JSON.parse(localStorage.getItem('omega_project')) || {
    files: [
        { id: '1', name: 'main.py', lang: 'python', content: 'print("Omega Engine Online")' },
        { id: '2', name: 'index.html', lang: 'html', content: '<h1>Hello Omega</h1>' }
    ]
};

const EXT_MAP = { py: 'python', cpp: 'cpp', java: 'java', js: 'javascript', html: 'html', css: 'css' };

// --- EDITOR INIT ---
require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
require(['vs/editor/editor.main'], function() {
    const initialFile = projectData.files[0];
    activeId = initialFile.id;

    editor = monaco.editor.create(document.getElementById('editor-container'), {
        value: initialFile.content,
        language: initialFile.lang,
        theme: 'vs-dark',
        automaticLayout: true,
        fontSize: 15,
        fontFamily: 'Fira Code',
        minimap: { enabled: false },
        padding: { top: 20 },
        roundedSelection: true,
        scrollBeyondLastLine: false,
    });

    // Auto-Save and Character Count
    editor.onDidChangeModelContent(() => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveData, 500);
        document.getElementById('char-count').innerText = `${editor.getValue().length} chars`;
    });

    initResizer();
    renderProject();
    updateXP(0);
});

// --- CORE FUNCTIONS ---

function saveData() {
    const file = projectData.files.find(f => f.id === activeId);
    if (file) {
        file.content = editor.getValue();
        localStorage.setItem('omega_project', JSON.stringify(projectData));
    }
}

async function runCode() {
    const file = projectData.files.find(f => f.id === activeId);
    const output = document.getElementById('terminal-output');
    
    if (file.lang === 'html') {
        switchOut('web');
        document.getElementById('web-frame').srcdoc = file.content;
        updateXP(10);
        return;
    }

    switchOut('term');
    output.innerHTML += `<div class="text-emerald-500 font-bold mt-2">>>> Executing ${file.name}...</div>`;
    
    try {
        const res = await fetch('https://emkc.org/api/v2/piston/execute', {
            method: 'POST',
            body: JSON.stringify({
                language: file.lang,
                version: "*",
                files: [{ content: file.content }]
            })
        });
        const data = await res.json();
        if (data.run.stdout) output.innerHTML += `<pre class="text-gray-300">${data.run.stdout}</pre>`;
        if (data.run.stderr) output.innerHTML += `<pre class="err-text">${data.run.stderr}</pre>`;
        updateXP(20);
    } catch (e) {
        output.innerHTML += `<div class="err-text">Execution Error: System Offline</div>`;
    }
    output.parentElement.scrollTop = output.parentElement.scrollHeight;
}

function createNewFile() {
    const name = prompt("Filename (e.g. app.js):", "script.py");
    if (!name) return;
    const ext = name.split('.').pop();
    const id = Date.now().toString();
    
    projectData.files.push({
        id, name, 
        lang: EXT_MAP[ext] || 'plaintext',
        content: ''
    });
    
    switchFile(id);
    updateXP(5);
}

function switchFile(id) {
    saveData();
    activeId = id;
    const file = projectData.files.find(f => f.id === id);
    
    editor.setValue(file.content);
    monaco.editor.setModelLanguage(editor.getModel(), file.lang);
    renderProject();
}

function renderProject() {
    const tree = document.getElementById('file-tree');
    const tabs = document.getElementById('tabs-bar');
    tree.innerHTML = '';
    tabs.innerHTML = '';

    projectData.files.forEach(f => {
        const active = f.id === activeId;
        
        // Tree
        tree.innerHTML += `
            <div onclick="switchFile('${f.id}')" class="p-3 rounded-xl text-[11px] cursor-pointer flex justify-between group transition-all ${active ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : 'text-gray-500 hover:bg-white/5'}">
                <span class="font-bold"><i class="fa-solid fa-file-code mr-3"></i>${f.name}</span>
                <i onclick="deleteFile(event, '${f.id}')" class="fa-solid fa-trash opacity-0 group-hover:opacity-100 hover:text-red-500"></i>
            </div>`;

        // Tabs
        tabs.innerHTML += `
            <div onclick="switchFile('${f.id}')" class="px-6 py-2 text-[10px] font-black cursor-pointer uppercase transition-all ${active ? 'tab-active' : 'text-gray-600 hover:text-gray-300'}">
                ${f.name}
            </div>`;
    });
    
    document.getElementById('lang-select').value = projectData.files.find(f => f.id === activeId).lang;
}

function deleteFile(e, id) {
    e.stopPropagation();
    if (projectData.files.length === 1) return alert("Keep at least one file.");
    projectData.files = projectData.files.filter(f => f.id !== id);
    if (activeId === id) activeId = projectData.files[0].id;
    switchFile(activeId);
}

// --- UI HELPERS ---

function switchOut(t) {
    document.getElementById('console-view').classList.toggle('hidden', t !== 'term');
    document.getElementById('preview-view').classList.toggle('hidden', t !== 'web');
    document.getElementById('tab-term').classList.toggle('text-emerald-500', t === 'term');
    document.getElementById('tab-term').classList.toggle('border-b-2', t === 'term');
    document.getElementById('tab-web').classList.toggle('text-emerald-500', t === 'web');
    document.getElementById('tab-web').classList.toggle('border-b-2', t === 'web');
}

function updateXP(v) {
    xp += v;
    localStorage.setItem('omega_xp', xp);
    document.getElementById('user-level').innerText = Math.floor(xp / 100) + 1;
    document.getElementById('xp-bar').style.width = (xp % 100) + '%';
}

function initResizer() {
    const resizer = document.getElementById('resizer');
    const panel = document.getElementById('output-panel');
    let isResizing = false;

    resizer.addEventListener('mousedown', () => isResizing = true);
    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const width = window.innerWidth - e.clientX;
        if (width > 200 && width < 900) panel.style.width = width + 'px';
    });
    document.addEventListener('mouseup', () => isResizing = false);
}

function openModal(id) {
    document.getElementById('modal-overlay').classList.remove('hidden');
    document.getElementById(`modal-${id}`).classList.remove('hidden');
}

function closeModals() {
    document.getElementById('modal-overlay').classList.add('hidden');
    document.querySelectorAll('[id^="modal-"]').forEach(m => m.classList.add('hidden'));
}

function clearConsole() { document.getElementById('terminal-output').innerHTML = ''; }

function exportProject() {
    const blob = new Blob([JSON.stringify(projectData)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'omega_project.json';
    a.click();
}

function updateLangManual() {
    const file = projectData.files.find(f => f.id === activeId);
    file.lang = document.getElementById('lang-select').value;
    monaco.editor.setModelLanguage(editor.getModel(), file.lang);
}
